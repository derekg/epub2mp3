<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inkvoice</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #fafafa;
            --surface: #ffffff;
            --surface-raised: #ffffff;
            --border: #e5e5e5;
            --border-subtle: #f0f0f0;
            --text: #171717;
            --text-secondary: #525252;
            --text-muted: #a3a3a3;
            --accent: #171717;
            --accent-hover: #404040;
            --success: #22c55e;
            --error: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 640px;
            margin: 0 auto;
            padding: 48px 24px;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 48px;
        }

        .logo {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 2.5rem;
            font-weight: 600;
            letter-spacing: -0.03em;
            color: var(--text);
            margin-bottom: 16px;
        }

        .intro {
            max-width: 420px;
            margin: 0 auto;
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.7;
        }

        .intro strong {
            color: var(--text);
            font-weight: 500;
        }

        /* Cards */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .card-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--text);
            color: var(--surface);
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text);
        }

        /* Drop zone */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 48px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg);
        }

        .drop-zone:hover {
            border-color: var(--text-muted);
            background: #f5f5f5;
        }

        .drop-zone.dragover {
            border-color: var(--accent);
            background: #f0f0f0;
        }

        .drop-zone.has-file {
            border-style: solid;
            border-color: var(--accent);
            background: var(--surface);
        }

        .drop-zone-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            color: var(--text-muted);
        }

        .drop-zone-text {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .drop-zone-hint {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .file-input { display: none; }

        /* Book info */
        .book-info {
            display: none;
            padding: 20px 24px;
            background: var(--bg);
            border-radius: 8px;
            margin-top: 20px;
        }

        .book-info.has-cover {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .book-info.no-cover {
            display: block;
        }

        .book-cover {
            width: 80px;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .book-cover:not([src]), .book-cover[src=""] {
            display: none;
        }

        .book-details {
            flex: 1;
            min-width: 0;
        }

        .book-title {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .book-author {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-style: italic;
            margin-bottom: 8px;
        }

        .book-stats {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        /* Chapter list */
        .chapters-card { display: none; }

        .chapter-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .chapter-info {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .chapter-actions {
            display: flex;
            gap: 16px;
        }

        .chapter-actions button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            padding: 0;
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .chapter-actions button:hover {
            color: var(--text);
        }

        .chapter-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .chapter-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: background 0.15s;
        }

        .chapter-item:last-child { border-bottom: none; }
        .chapter-item:hover { background: var(--bg); }

        .chapter-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 14px;
            accent-color: var(--accent);
        }

        .chapter-item .title {
            flex: 1;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chapter-item .meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-left: 12px;
        }

        .badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.02em;
            background: var(--bg);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        /* Duration estimate */
        .duration-estimate {
            display: none;
            margin-top: 16px;
            padding: 14px 16px;
            background: var(--bg);
            border-radius: 8px;
            justify-content: space-between;
            align-items: center;
        }

        .duration-estimate-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .duration-estimate-value {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text);
        }

        .duration-estimate-note {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
            text-align: right;
        }

        .duration-estimate-right {
            text-align: right;
        }

        /* Options */
        .options-card { display: none; }

        .option-group {
            margin-bottom: 24px;
        }

        .option-group:last-child {
            margin-bottom: 0;
        }

        .option-group-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .option-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .option-row:last-child {
            margin-bottom: 0;
        }

        select {
            flex: 1;
            padding: 10px 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.9rem;
            cursor: pointer;
        }

        select:hover { border-color: var(--text-muted); }
        select:focus { outline: none; border-color: var(--accent); }

        .voice-row {
            display: flex;
            gap: 8px;
            flex: 1;
        }

        .voice-row select { flex: 1; }

        .preview-btn {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .preview-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .preview-btn.playing {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--surface);
        }

        .checkbox-option {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            padding: 8px 0;
        }

        .checkbox-option input {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
            margin-top: 1px;
        }

        .checkbox-label {
            flex: 1;
        }

        .checkbox-label-text {
            font-size: 0.9rem;
            color: var(--text);
        }

        .checkbox-label-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .processing-note {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 8px;
            padding: 8px 12px;
            background: var(--bg);
            border-radius: 6px;
        }

        .processing-note.ready {
            color: var(--text-secondary);
        }

        .processing-note.warning {
            color: var(--text-secondary);
        }

        /* Buttons */
        .convert-btn {
            width: 100%;
            padding: 16px 24px;
            background: var(--accent);
            color: var(--surface);
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 24px;
        }

        .convert-btn:hover:not(:disabled) {
            background: var(--accent-hover);
        }

        .convert-btn:disabled {
            background: var(--border);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        /* Progress */
        .progress-section {
            display: none;
            margin-top: 32px;
            padding-top: 32px;
            border-top: 1px solid var(--border);
        }

        .progress-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 16px;
            font-size: 0.85rem;
        }

        .progress-status {
            color: var(--text);
            font-weight: 500;
        }

        .progress-percent {
            color: var(--text-muted);
        }

        .progress-details {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-top: 20px;
            padding: 16px;
            background: var(--bg);
            border-radius: 8px;
        }

        .progress-detail {
            text-align: center;
        }

        .progress-detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }

        .progress-detail-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 4px;
        }

                .cancel-btn {
            display: none;
            margin-top: 20px;
            width: 100%;
            padding: 10px 20px;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cancel-btn:hover:not(:disabled) {
            border-color: var(--error);
            color: var(--error);
        }

        .cancel-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Downloads */
        .downloads-section {
            display: none;
            margin-top: 32px;
            padding-top: 32px;
            border-top: 1px solid var(--border);
        }

        .downloads-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .downloads-header h3 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
        }

        .success-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
        }

        .download-list {
            list-style: none;
        }

        .download-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .download-list a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
        }

        .download-list a:hover {
            text-decoration: underline;
        }

        .download-all-btn {
            width: 100%;
            padding: 12px 16px;
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.2s;
        }

        .download-all-btn:hover {
            background: var(--bg);
            border-color: var(--text-muted);
        }

        /* Error */
        .error {
            color: var(--error);
            font-size: 0.9rem;
            margin-top: 16px;
            padding: 12px 16px;
            background: #fef2f2;
            border-radius: 8px;
            display: none;
        }

        .error:not(:empty) {
            display: block;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 32px 24px;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        footer a {
            color: var(--text-secondary);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }


        /* History */
        .history-section {
            margin-top: 48px;
        }

        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .history-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .history-clear-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0;
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .history-clear-btn:hover {
            color: var(--error);
        }

        .history-entry {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px 24px;
            margin-bottom: 12px;
        }

        .history-entry-header {
            margin-bottom: 12px;
        }

        .history-entry-title {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text);
            line-height: 1.3;
        }

        .history-entry-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .history-entry-files {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .history-file-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.82rem;
            color: var(--accent);
            text-decoration: none;
            padding: 4px 10px;
            border: 1px solid var(--border);
            border-radius: 5px;
            background: var(--bg);
            transition: all 0.15s;
        }

        .history-file-link:hover {
            border-color: var(--accent);
            background: var(--surface);
        }

        .history-file-expired {
            font-size: 0.82rem;
            color: var(--text-muted);
            padding: 4px 10px;
            border: 1px solid var(--border-subtle);
            border-radius: 5px;
            background: var(--bg);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .history-file-expired .filename {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .expired-badge {
            font-size: 0.65rem;
            padding: 1px 5px;
            border-radius: 3px;
            background: var(--border);
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.04em;
        }

        /* Mobile */
        @media (max-width: 480px) {
            .container { padding: 32px 16px; }
            .card { padding: 24px 20px; }
            .logo { font-size: 2rem; }
            .progress-details { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="logo">Inkvoice</h1>
            <p class="intro">
                Convert any EPUB into a high-quality audiobook.
                AI-powered text-to-speech that actually sounds good.
            </p>
        </header>

        <!-- Step 1: Upload -->
        <div class="card">
            <div class="card-header">
                <span class="card-number">1</span>
                <span class="card-title">Choose your book</span>
            </div>

            <div class="drop-zone" id="dropZone">
                <svg class="drop-zone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                <p class="drop-zone-text">Drop your EPUB here or click to browse</p>
                <p class="drop-zone-hint">EPUB files only</p>
                <input type="file" class="file-input" id="epubInput" accept=".epub">
            </div>

            <div class="book-info" id="bookInfo">
                <img class="book-cover" id="bookCover" src="" alt="">
                <div class="book-details">
                    <div class="book-title" id="bookTitle"></div>
                    <div class="book-author" id="bookAuthor"></div>
                    <div class="book-stats" id="bookStats"></div>
                </div>
            </div>
        </div>

        <!-- Step 2: Chapters -->
        <div class="card chapters-card" id="chaptersCard">
            <div class="card-header">
                <span class="card-number">2</span>
                <span class="card-title">Select chapters</span>
            </div>

            <div class="chapter-controls">
                <span class="chapter-info" id="selectionStats"></span>
                <div class="chapter-actions">
                    <button onclick="selectAll()">Select all</button>
                    <button onclick="selectNone()">Clear</button>
                </div>
            </div>

            <div class="chapter-list" id="chapterList"></div>
            <div class="duration-estimate" id="durationEstimate">
                <span class="duration-estimate-label">Estimated listening time</span>
                <div class="duration-estimate-right">
                    <div class="duration-estimate-value" id="durationEstimateValue"></div>
                    <div class="duration-estimate-note" id="durationEstimateNote"></div>
                </div>
            </div>
        </div>

        <!-- Step 3: Options -->
        <div class="card options-card" id="optionsCard">
            <div class="card-header">
                <span class="card-number">3</span>
                <span class="card-title">Configure output</span>
            </div>

            <div class="option-group">
                <div class="option-group-title">Voice</div>
                <div class="option-row">
                    <div class="voice-row">
                        <select id="voiceSelect"></select>
                        <button type="button" class="preview-btn" id="previewBtn" title="Preview voice">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="option-group">
                <div class="option-group-title">Format</div>
                <div class="option-row">
                    <select id="formatSelect">
                        <option value="mp3">MP3 (separate files)</option>
                        <option value="m4b" id="m4bOption" disabled>M4B audiobook (single file with chapters)</option>
                    </select>
                </div>
            </div>

            <div class="option-group">
                <div class="option-group-title">Text processing</div>
                <div class="option-row">
                    <select id="textProcessingSelect">
                        <option value="none">Original text</option>
                        <option value="clean">Narration-ready (remove footnotes, references)</option>
                        <option value="speed">Condensed (~30% shorter)</option>
                        <option value="summary">Key points only (~10%)</option>
                    </select>
                </div>
                <div class="processing-note" id="processingNote" style="display: none;"></div>
            </div>

            <div class="option-group">
                <div class="option-group-title">Options</div>
                <label class="checkbox-option">
                    <input type="checkbox" id="announceChapters">
                    <div class="checkbox-label">
                        <div class="checkbox-label-text">Announce chapter titles</div>
                        <div class="checkbox-label-hint">Voice will read the chapter name at the start</div>
                    </div>
                </label>
                <label class="checkbox-option" id="perChapterOption">
                    <input type="checkbox" id="perChapter" checked>
                    <div class="checkbox-label">
                        <div class="checkbox-label-text">One file per chapter</div>
                        <div class="checkbox-label-hint">Creates separate MP3 files for each chapter</div>
                    </div>
                </label>
            </div>

            <button class="convert-btn" id="convertBtn" disabled>Select an EPUB to begin</button>

            <div class="error" id="errorText"></div>

            <div class="progress-section" id="progressSection">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-info">
                    <span class="progress-status" id="progressStatus">Starting...</span>
                    <span class="progress-percent" id="progressPercent">0%</span>
                </div>
                <div class="progress-details">
                    <div class="progress-detail">
                        <div class="progress-detail-value" id="progressChapter">-</div>
                        <div class="progress-detail-label">Chapter</div>
                    </div>
                    <div class="progress-detail">
                        <div class="progress-detail-value" id="progressElapsed">0:00</div>
                        <div class="progress-detail-label">Elapsed</div>
                    </div>
                    <div class="progress-detail">
                        <div class="progress-detail-value" id="progressRemaining">--:--</div>
                        <div class="progress-detail-label">Remaining</div>
                    </div>
                    <div class="progress-detail">
                        <div class="progress-detail-value" id="progressWords">-</div>
                        <div class="progress-detail-label">Words</div>
                    </div>
                </div>
                <button class="cancel-btn" id="cancelBtn">Cancel</button>
            </div>

            <div class="downloads-section" id="downloadsSection">
                <div class="downloads-header">
                    <span class="success-dot"></span>
                    <h3>Ready for download</h3>
                </div>
                <ul class="download-list" id="downloadList"></ul>
                <button class="download-all-btn" id="downloadAllBtn">Download all as ZIP</button>
            </div>
        </div>

    <!-- Job History -->
    <div class="history-section" id="historySection" style="display:none;">
        <div class="history-header">
            <span class="history-title">Recent Conversions</span>
            <button class="history-clear-btn" id="historyClearBtn">Clear history</button>
        </div>
        <div id="historyList"></div>
    </div>

    </div>

    <footer>
        Powered by <a href="https://github.com/kyutai-labs/pocket-tts" target="_blank">Pocket TTS</a>
        and <a href="https://ai.google.dev/" target="_blank">Gemini</a>
    </footer>

    <script>
        // Elements
        const dropZone = document.getElementById('dropZone');
        const epubInput = document.getElementById('epubInput');
        const bookInfo = document.getElementById('bookInfo');
        const bookCover = document.getElementById('bookCover');
        const bookTitle = document.getElementById('bookTitle');
        const bookAuthor = document.getElementById('bookAuthor');
        const bookStats = document.getElementById('bookStats');
        const chaptersCard = document.getElementById('chaptersCard');
        const chapterList = document.getElementById('chapterList');
        const selectionStats = document.getElementById('selectionStats');
        const optionsCard = document.getElementById('optionsCard');
        const voiceSelect = document.getElementById('voiceSelect');
        const formatSelect = document.getElementById('formatSelect');
        const m4bOption = document.getElementById('m4bOption');
        const textProcessingSelect = document.getElementById('textProcessingSelect');
        const processingNote = document.getElementById('processingNote');
        const announceChapters = document.getElementById('announceChapters');
        const perChapter = document.getElementById('perChapter');
        const perChapterOption = document.getElementById('perChapterOption');
        const convertBtn = document.getElementById('convertBtn');
        const errorText = document.getElementById('errorText');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressStatus = document.getElementById('progressStatus');
        const progressPercent = document.getElementById('progressPercent');
        const progressChapter = document.getElementById('progressChapter');
        const progressElapsed = document.getElementById('progressElapsed');
        const progressRemaining = document.getElementById('progressRemaining');
        const progressWords = document.getElementById('progressWords');
        const cancelBtn = document.getElementById('cancelBtn');
        const downloadsSection = document.getElementById('downloadsSection');
        const downloadList = document.getElementById('downloadList');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const previewBtn = document.getElementById('previewBtn');

        // State
        let uploadId = null;
        let chapters = [];
        let currentJobId = null;
        let m4bAvailable = false;
        let geminiAvailable = false;
        let ttsAvailable = false;
        let previewAudio = null;
        let voiceData = [];

        // Duration estimate constants
        const WORDS_PER_MINUTE = 150;
        const PROCESSING_MULTIPLIERS = {
            'none':    1.0,
            'clean':   1.0,
            'speed':   0.3,
            'summary': 0.1,
        };

        function getProcessingMultiplier() {
            return PROCESSING_MULTIPLIERS[textProcessingSelect.value] || 1.0;
        }

        function formatDuration(words, multiplier) {
            multiplier = multiplier !== undefined ? multiplier : getProcessingMultiplier();
            const effectiveWords = Math.round(words * multiplier);
            const totalMins = Math.round(effectiveWords / WORDS_PER_MINUTE);
            const hours = Math.floor(totalMins / 60);
            const mins = totalMins % 60;
            if (hours > 0) return `${hours}h ${mins}m`;
            return `${totalMins}m`;
        }

        function formatChapterDuration(words) {
            const multiplier = getProcessingMultiplier();
            const effectiveWords = Math.round(words * multiplier);
            const mins = Math.round(effectiveWords / WORDS_PER_MINUTE);
            if (mins < 1) return '<1 min';
            return `~${mins} min`;
        }

        // Icons
        const playIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
        const stopIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12"/></svg>';
        const loadingIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" opacity="0.3"/><path d="M12 2a10 10 0 0 1 10 10"><animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/></path></svg>';

        // Load capabilities
        async function loadCapabilities() {
            try {
                const response = await fetch('/api/capabilities');
                const data = await response.json();

                m4bAvailable = data.formats.m4b;
                m4bOption.disabled = !m4bAvailable;
                m4bOption.textContent = m4bAvailable
                    ? 'M4B audiobook (single file with chapters)'
                    : 'M4B (requires ffmpeg)';

                // Default to M4B if available
                if (m4bAvailable) {
                    formatSelect.value = 'm4b';
                    perChapterOption.style.opacity = '0.5';
                    perChapter.disabled = true;
                    perChapter.checked = false;
                }

                geminiAvailable = data.gemini_available;
                ttsAvailable = data.tts_available;

                // Default to "clean" if Gemini is available
                if (geminiAvailable) {
                    textProcessingSelect.value = 'clean';
                    processingNote.style.display = 'block';
                    processingNote.className = 'processing-note ready';
                    processingNote.textContent = 'Gemini removes footnotes, URLs, and other non-spoken content';
                }

                if (!ttsAvailable) {
                    convertBtn.textContent = 'TTS not available';
                    showError('TTS engine not configured. Please check installation.');
                }
            } catch (e) {
                console.error('Failed to load capabilities:', e);
            }
        }

        function updateButtonText() {
            if (uploadId) {
                convertBtn.textContent = `Convert to ${formatSelect.value.toUpperCase()}`;
            }
        }

        // Load voices
        async function loadVoices() {
            try {
                const response = await fetch('/api/voices');
                const data = await response.json();
                voiceData = data.voices;

                voiceSelect.innerHTML = '';

                const groups = {
                    narration: { label: 'Narration', voices: [] },
                    casual: { label: 'Casual', voices: [] },
                    neutral: { label: 'Neutral', voices: [] },
                    character: { label: 'Character', voices: [] }
                };

                voiceData.forEach(v => {
                    const group = groups[v.best_for] || groups.neutral;
                    group.voices.push(v);
                });

                for (const [key, group] of Object.entries(groups)) {
                    if (group.voices.length === 0) continue;
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = group.label;

                    group.voices.forEach(v => {
                        const option = document.createElement('option');
                        option.value = v.name;
                        option.textContent = `${v.name} — ${v.characteristic}`;
                        if (v.name === data.default) option.selected = true;
                        optgroup.appendChild(option);
                    });

                    voiceSelect.appendChild(optgroup);
                }
            } catch (e) {
                console.error('Failed to load voices:', e);
            }
        }

        // Initialize
        loadCapabilities();
        loadVoices();

        // Text processing note
        textProcessingSelect.addEventListener('change', () => {
            const mode = textProcessingSelect.value;
            if (mode === 'none') {
                processingNote.style.display = 'none';
            } else if (mode === 'clean') {
                processingNote.style.display = 'block';
                processingNote.className = 'processing-note' + (geminiAvailable ? ' ready' : ' warning');
                processingNote.textContent = geminiAvailable
                    ? 'Gemini removes footnotes, URLs, and other non-spoken content'
                    : 'Gemini not configured — basic cleanup only';
            } else if (mode === 'speed') {
                processingNote.style.display = 'block';
                processingNote.className = 'processing-note' + (geminiAvailable ? ' ready' : ' warning');
                processingNote.textContent = geminiAvailable
                    ? 'Gemini condenses while preserving key information'
                    : 'Requires Gemini API';
            } else {
                processingNote.style.display = 'block';
                processingNote.className = 'processing-note' + (geminiAvailable ? ' ready' : ' warning');
                processingNote.textContent = geminiAvailable
                    ? 'Gemini extracts main ideas and conclusions'
                    : 'Requires Gemini API';
            }
            // Re-compute duration estimates when processing mode changes
            updateSelectionStats();
            // Refresh per-chapter duration labels
            chapterList.querySelectorAll('.chapter-item .meta').forEach((meta, i) => {
                const ch = chapters[i];
                if (ch) meta.textContent = `${formatWords(ch.words)} · ${formatChapterDuration(ch.words)}`;
            });
        });

        // Format change
        formatSelect.addEventListener('change', () => {
            const isM4B = formatSelect.value === 'm4b';
            perChapterOption.style.opacity = isM4B ? '0.5' : '1';
            perChapter.disabled = isM4B;
            if (isM4B) perChapter.checked = false;
            updateButtonText();
        });

        // Voice preview
        previewBtn.addEventListener('click', async () => {
            if (previewAudio && !previewAudio.paused) {
                previewAudio.pause();
                previewAudio.currentTime = 0;
                previewBtn.innerHTML = playIcon;
                previewBtn.classList.remove('playing');
                return;
            }

            previewBtn.disabled = true;
            previewBtn.innerHTML = loadingIcon;

            try {
                if (!previewAudio) {
                    previewAudio = new Audio();
                    previewAudio.addEventListener('ended', () => {
                        previewBtn.innerHTML = playIcon;
                        previewBtn.classList.remove('playing');
                    });
                }

                previewAudio.src = `/api/voice-preview/${voiceSelect.value}`;
                await previewAudio.play();
                previewBtn.innerHTML = stopIcon;
                previewBtn.classList.add('playing');
            } catch (e) {
                console.error('Preview failed:', e);
                previewBtn.innerHTML = playIcon;
            }
            previewBtn.disabled = false;
        });

        voiceSelect.addEventListener('change', () => {
            if (previewAudio && !previewAudio.paused) {
                previewAudio.pause();
                previewBtn.innerHTML = playIcon;
                previewBtn.classList.remove('playing');
            }
        });

        // Drag and drop
        dropZone.addEventListener('click', () => epubInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length && e.dataTransfer.files[0].name.endsWith('.epub')) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        epubInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        async function handleFile(file) {
            dropZone.classList.add('has-file');
            dropZone.querySelector('.drop-zone-text').textContent = 'Parsing...';
            dropZone.querySelector('.drop-zone-hint').textContent = file.name;
            clearError();

            const formData = new FormData();
            formData.append('epub_file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Failed to parse EPUB');

                const data = await response.json();
                uploadId = data.upload_id;
                chapters = data.chapters;

                // Show book info
                bookTitle.textContent = data.title;
                bookAuthor.textContent = data.author ? `by ${data.author}` : '';

                const hours = Math.floor(data.total_words / 150 / 60);
                const mins = Math.round((data.total_words / 150) % 60);
                const duration = hours > 0 ? `~${hours}h ${mins}m` : `~${mins} min`;
                bookStats.textContent = `${data.total_words.toLocaleString()} words · ${duration} audio`;

                // Show cover if available
                if (data.has_cover) {
                    bookCover.src = `/api/cover/${uploadId}`;
                    bookInfo.className = 'book-info has-cover';
                } else {
                    bookCover.src = '';
                    bookInfo.className = 'book-info no-cover';
                }

                dropZone.querySelector('.drop-zone-text').textContent = file.name;
                dropZone.querySelector('.drop-zone-hint').textContent = 'Click to change';

                // Show chapters and options
                renderChapters();
                chaptersCard.style.display = 'block';
                optionsCard.style.display = 'block';

                convertBtn.disabled = false;
                convertBtn.textContent = `Convert to ${formatSelect.value.toUpperCase()}`;

            } catch (error) {
                showError(error.message);
                dropZone.classList.remove('has-file');
                dropZone.querySelector('.drop-zone-text').textContent = 'Drop your EPUB here or click to browse';
                dropZone.querySelector('.drop-zone-hint').textContent = 'EPUB files only';
            }
        }

        function renderChapters() {
            chapterList.innerHTML = '';
            chapters.forEach((ch, i) => {
                const isContent = !ch.is_front_matter && !ch.is_back_matter;
                const div = document.createElement('div');
                div.className = 'chapter-item';

                let badge = '';
                if (ch.is_front_matter) badge = '<span class="badge">front</span>';
                if (ch.is_back_matter) badge = '<span class="badge">back</span>';

                div.innerHTML = `
                    <input type="checkbox" ${isContent ? 'checked' : ''} data-index="${i}">
                    <span class="title">${ch.title}${badge}</span>
                    <span class="meta">${formatWords(ch.words)} · ${formatChapterDuration(ch.words)}</span>
                `;

                div.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const cb = div.querySelector('input');
                        cb.checked = !cb.checked;
                        updateSelectionStats();
                    }
                });
                div.querySelector('input').addEventListener('change', updateSelectionStats);
                chapterList.appendChild(div);
            });
            updateSelectionStats();
        }

        function updateSelectionStats() {
            const selected = getSelectedChapters();
            const words = selected.reduce((sum, i) => sum + chapters[i].words, 0);
            const multiplier = getProcessingMultiplier();
            const duration = formatDuration(words, multiplier);
            selectionStats.textContent = `${selected.length} of ${chapters.length} · ${words.toLocaleString()} words`;

            // Update duration estimate banner
            const durationEstimate = document.getElementById('durationEstimate');
            const durationEstimateValue = document.getElementById('durationEstimateValue');
            const durationEstimateNote = document.getElementById('durationEstimateNote');
            if (words > 0) {
                durationEstimate.style.display = 'flex';
                durationEstimateValue.textContent = duration;
                const mode = textProcessingSelect.value;
                if (mode === 'speed') {
                    durationEstimateNote.textContent = 'condensed to ~30%';
                } else if (mode === 'summary') {
                    durationEstimateNote.textContent = 'key points only (~10%)';
                } else {
                    durationEstimateNote.textContent = '';
                }
            } else {
                durationEstimate.style.display = 'none';
            }
        }

        function formatWords(n) {
            return n >= 1000 ? `${(n/1000).toFixed(1)}k` : n.toString();
        }

        function selectAll() {
            chapterList.querySelectorAll('input').forEach(cb => cb.checked = true);
            updateSelectionStats();
        }

        function selectNone() {
            chapterList.querySelectorAll('input').forEach(cb => cb.checked = false);
            updateSelectionStats();
        }

        function getSelectedChapters() {
            return Array.from(chapterList.querySelectorAll('input:checked'))
                .map(cb => parseInt(cb.dataset.index));
        }

        // Conversion
        convertBtn.addEventListener('click', startConversion);

        cancelBtn.addEventListener('click', async () => {
            if (!currentJobId) return;
            // Optimistic UI: disable immediately
            cancelBtn.disabled = true;
            cancelBtn.textContent = 'Cancelling...';
            try {
                await fetch(`/api/cancel/${currentJobId}`, { method: 'DELETE' });
            } catch (e) {
                // Ignore network errors — the SSE handler will catch the cancelled status
            }
        });

        async function startConversion() {
            const selected = getSelectedChapters();
            if (selected.length === 0) {
                showError('Please select at least one chapter');
                return;
            }

            convertBtn.disabled = true;
            convertBtn.textContent = 'Converting...';
            progressSection.style.display = 'block';
            downloadsSection.style.display = 'none';
            clearError();

            progressFill.style.width = '0%';
            progressPercent.textContent = '0%';
            progressStatus.textContent = 'Starting...';
            cancelBtn.style.display = 'block';
            cancelBtn.disabled = false;
            cancelBtn.textContent = 'Cancel';

            const formData = new FormData();
            formData.append('upload_id', uploadId);
            formData.append('selected_chapters', JSON.stringify(selected));
            formData.append('voice', voiceSelect.value);
            formData.append('output_format', formatSelect.value);
            formData.append('per_chapter', perChapter.checked);
            formData.append('announce_chapters', announceChapters.checked);
            formData.append('text_processing', textProcessingSelect.value);

            try {
                const response = await fetch('/api/convert', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Conversion failed');

                const data = await response.json();
                currentJobId = data.job_id;
                listenForProgress(currentJobId);
            } catch (error) {
                showError(error.message);
            }
        }

        function formatTime(seconds) {
            if (seconds == null) return '--:--';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return h > 0
                ? `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`
                : `${m}:${s.toString().padStart(2, '0')}`;
        }

        function listenForProgress(jobId) {
            const eventSource = new EventSource(`/api/progress/${jobId}`);

            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);

                progressFill.style.width = `${data.progress}%`;
                progressPercent.textContent = `${Math.round(data.progress)}%`;
                progressStatus.textContent = data.message;

                if (data.details) {
                    const d = data.details;
                    if (d.chapter_total > 0) {
                        progressChapter.textContent = `${d.chapter_current || 0}/${d.chapter_total}`;
                    }
                    progressElapsed.textContent = formatTime(d.elapsed_seconds);
                    progressRemaining.textContent = formatTime(d.estimated_remaining_seconds);
                    if (d.words_total > 0) {
                        progressWords.textContent = `${formatWords(d.words_processed)}/${formatWords(d.words_total)}`;
                    }
                }

                if (data.status === 'complete') {
                    cancelBtn.style.display = 'none';
                    eventSource.close();
                    showDownloads(jobId, data.files);
                } else if (data.status === 'cancelled') {
                    cancelBtn.style.display = 'none';
                    eventSource.close();
                    showError('Conversion was cancelled.');
                } else if (data.status === 'error') {
                    cancelBtn.style.display = 'none';
                    eventSource.close();
                    showError(data.message);
                }
            };

            eventSource.onerror = () => {
                cancelBtn.style.display = 'none';
                eventSource.close();
                showError('Connection lost');
            };
        }

        function showDownloads(jobId, files) {
            convertBtn.disabled = false;
            convertBtn.textContent = `Convert to ${formatSelect.value.toUpperCase()}`;
            cancelBtn.style.display = 'none';

            downloadList.innerHTML = '';

            // Save to history
            addHistoryEntry({
                jobId,
                title: bookTitle.textContent || 'Unknown title',
                author: (bookAuthor.textContent || '').replace(/^by /, ''),
                files: files,
                completedAt: new Date().toISOString(),
            });
            files.forEach(file => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${file}</span>
                    <a href="/api/download/${jobId}/${encodeURIComponent(file)}" download>Download</a>
                `;
                downloadList.appendChild(li);
            });

            downloadAllBtn.style.display = files.length > 1 ? 'block' : 'none';
            downloadAllBtn.onclick = () => window.location.href = `/api/download-all/${jobId}`;

            downloadsSection.style.display = 'block';
        }

        function showError(message) {
            errorText.textContent = message;
            convertBtn.textContent = 'Try again';
            convertBtn.disabled = false;
            progressSection.style.display = 'none';
        }


        // ── Job History (localStorage) ──────────────────────────────────────

        const HISTORY_KEY = 'inkvoice_history';
        const HISTORY_MAX = 10;

        function loadHistory() {
            try {
                return JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            } catch {
                return [];
            }
        }

        function saveHistory(entries) {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(entries));
        }

        function addHistoryEntry(entry) {
            const entries = loadHistory();
            // Deduplicate by jobId
            const filtered = entries.filter(e => e.jobId !== entry.jobId);
            // Prepend newest, cap at HISTORY_MAX
            filtered.unshift(entry);
            saveHistory(filtered.slice(0, HISTORY_MAX));
            renderHistory();
        }

        function clearHistory() {
            localStorage.removeItem(HISTORY_KEY);
            renderHistory();
        }

        function formatHistoryDate(isoString) {
            try {
                const d = new Date(isoString);
                return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' })
                    + ' at '
                    + d.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
            } catch {
                return isoString;
            }
        }

        async function renderHistory() {
            const entries = loadHistory();
            const section = document.getElementById('historySection');
            const list = document.getElementById('historyList');

            if (entries.length === 0) {
                section.style.display = 'none';
                list.innerHTML = '';
                return;
            }

            section.style.display = 'block';
            list.innerHTML = '';

            for (const entry of entries) {
                const div = document.createElement('div');
                div.className = 'history-entry';

                const authorPart = entry.author ? `${escapeHtml(entry.author)} · ` : '';
                const datePart = formatHistoryDate(entry.completedAt);

                div.innerHTML = `
                    <div class="history-entry-header">
                        <div class="history-entry-title">${escapeHtml(entry.title)}</div>
                        <div class="history-entry-meta">${authorPart}${datePart}</div>
                    </div>
                    <div class="history-entry-files" data-jobid="${entry.jobId}"></div>
                `;

                list.appendChild(div);

                // Render file links (check availability asynchronously)
                const filesContainer = div.querySelector('.history-entry-files');
                for (const filename of entry.files) {
                    const url = `/api/download/${entry.jobId}/${encodeURIComponent(filename)}`;
                    const pill = document.createElement('span');
                    pill.innerHTML = renderFilePill(filename, url, null); // null = loading
                    filesContainer.appendChild(pill);

                    // Check if file is still available
                    checkFileAvailable(url).then(available => {
                        pill.innerHTML = renderFilePill(filename, url, available);
                    });
                }
            }
        }

        function renderFilePill(filename, url, available) {
            if (available === null) {
                // Still checking — show as a normal link for now
                return `<a class="history-file-link" href="${url}" download>
                    <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    ${escapeHtml(filename)}
                </a>`;
            } else if (available) {
                return `<a class="history-file-link" href="${url}" download>
                    <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    ${escapeHtml(filename)}
                </a>`;
            } else {
                return `<span class="history-file-expired">
                    <span class="filename">${escapeHtml(filename)}</span>
                    <span class="expired-badge">Expired</span>
                </span>`;
            }
        }

        async function checkFileAvailable(url) {
            try {
                const res = await fetch(url, { method: 'HEAD' });
                return res.ok;
            } catch {
                return false;
            }
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Wire up Clear button
        document.getElementById('historyClearBtn').addEventListener('click', () => {
            if (confirm('Clear all conversion history?')) {
                clearHistory();
            }
        });

        // Render history on page load
        renderHistory();

        // ────────────────────────────────────────────────────────────────────

        function clearError() {
            errorText.textContent = '';
        }
    </script>
</body>
</html>
