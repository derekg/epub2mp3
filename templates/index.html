<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inkvoice</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #fafafa;
            --surface: #ffffff;
            --border: #e5e5e5;
            --border-subtle: #f0f0f0;
            --text: #171717;
            --text-secondary: #525252;
            --text-muted: #a3a3a3;
            --accent: #171717;
            --accent-hover: #404040;
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* ── Layout ──────────────────────────────────────────── */

        .page-layout {
            display: flex;
            align-items: flex-start;
            min-height: 100vh;
        }

        .main-column {
            flex: 1;
            min-width: 0;
        }

        .container {
            max-width: 640px;
            margin: 0 auto;
            padding: 48px 24px;
        }

        /* ── Jobs sidebar ─────────────────────────────────────── */

        .jobs-sidebar {
            width: 340px;
            flex-shrink: 0;
            padding: 48px 24px 48px 0;
            display: none;
            position: sticky;
            top: 0;
            max-height: 100vh;
            overflow-y: auto;
        }

        .jobs-sidebar.visible { display: block; }

        .jobs-sidebar-inner {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .jobs-sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .jobs-sidebar-title {
            font-size: 0.78rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text);
        }

        .jobs-count-badge {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        /* ── Job cards ────────────────────────────────────────── */

        .job-card {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
            animation: slideInRight 0.25s ease;
        }

        .job-card:last-child { border-bottom: none; }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(12px); }
            to   { opacity: 1; transform: translateX(0); }
        }

        .job-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 4px;
        }

        .job-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
            transition: background 0.3s;
        }

        .job-status-dot.processing {
            background: var(--warning);
            animation: dotPulse 1.5s ease-in-out infinite;
        }

        .job-status-dot.complete  { background: var(--success); }
        .job-status-dot.error     { background: var(--error); }
        .job-status-dot.cancelled { background: var(--text-muted); }

        @keyframes dotPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50%       { opacity: 0.4; transform: scale(0.85); }
        }

        .job-card-info {
            min-width: 0;
            padding-left: 18px; /* align under title, past the status dot */
        }

        .job-card-title {
            font-size: 0.88rem;
            font-weight: 500;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }

        .job-card-author {
            font-size: 0.74rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .job-card-status {
            font-size: 0.74rem;
            color: var(--text-muted);
            margin-top: 1px;
            font-style: italic;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .job-card-status.error-text { color: var(--error); font-style: normal; }

        /* Footer row for action buttons — right-aligned */
        .job-card-footer {
            display: flex;
            justify-content: flex-end;
            gap: 6px;
            margin-top: 6px;
        }

        .job-pct {
            font-size: 0.75rem;
            color: var(--text-muted);
            flex-shrink: 0;
            margin-left: 4px;
        }

        .job-progress-bar {
            height: 3px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin: 8px 0 4px;
        }

        .job-progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.4s ease;
        }

        .job-progress-fill.complete { background: var(--success); }
        .job-progress-fill.error    { background: var(--error); }

        /* Downloads inside job card */
        .job-downloads { display: none; }
        .job-downloads.visible { display: block; }

        .job-download-links {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 5px;
        }

        .job-download-link {
            font-size: 0.76rem;
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
            padding: 3px 8px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            display: block;
            transition: border-color 0.15s;
        }

        .job-download-link:hover { border-color: var(--text-muted); }

        .job-download-all-link {
            font-size: 0.76rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
        }

        .job-download-all-link:hover {
            text-decoration: underline;
            color: var(--text);
        }

        .job-error-msg {
            display: none;
            font-size: 0.76rem;
            color: var(--error);
            margin-top: 4px;
            line-height: 1.4;
        }

        .job-error-msg.visible { display: block; }

        /* Cancel button inside job card */
        .job-cancel-btn {
            display: none;
            background: none;
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--text-secondary);
            font-size: 0.74rem;
            font-weight: 500;
            cursor: pointer;
            padding: 4px 10px;
            margin-top: 8px;
            width: auto;
            transition: border-color 0.15s, color 0.15s;
        }

        .job-cancel-btn.visible { display: inline-block; }

        .job-cancel-btn:hover:not(:disabled) {
            border-color: var(--error);
            color: var(--error);
        }

        .job-cancel-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Resume button inside job card */
        .job-resume-btn {
            display: none;
            background: none;
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--text-secondary);
            font-size: 0.74rem;
            font-weight: 500;
            cursor: pointer;
            padding: 4px 10px;
            margin-top: 6px;
            width: auto;
            transition: border-color 0.15s, color 0.15s;
        }

        .job-resume-btn.visible { display: inline-block; }

        .job-resume-btn:hover:not(:disabled) {
            border-color: var(--accent);
            color: var(--accent);
        }

        .job-resume-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ── Header ───────────────────────────────────────────── */

        header {
            text-align: center;
            margin-bottom: 48px;
            animation: fadeSlideUp 0.4s ease;
        }

        .logo {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 2.5rem;
            font-weight: 600;
            letter-spacing: -0.03em;
            color: var(--text);
            margin-bottom: 12px;
        }

        .intro {
            max-width: 400px;
            margin: 0 auto;
            color: var(--text-secondary);
            font-size: 0.97rem;
            line-height: 1.7;
        }

        /* ── Cards ────────────────────────────────────────────── */

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 28px 28px;
            margin-bottom: 20px;
            animation: fadeSlideUp 0.35s ease both;
        }

        .card:nth-child(2) { animation-delay: 0.05s; }
        .card:nth-child(3) { animation-delay: 0.10s; }
        .card:nth-child(4) { animation-delay: 0.15s; }

        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .card-number {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: var(--text);
            color: var(--surface);
            font-size: 0.78rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .card-title {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text);
        }

        /* ── Drop zone ────────────────────────────────────────── */

        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 40px 24px 36px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
            background: var(--bg);
            position: relative;
        }

        .drop-zone:hover {
            border-color: var(--text-secondary);
            background: #f5f5f5;
            box-shadow: inset 0 0 0 3px rgba(0,0,0,0.03);
        }

        .drop-zone.dragover {
            border-color: var(--accent);
            background: #f0f0f0;
            box-shadow: inset 0 0 0 3px rgba(0,0,0,0.04);
        }

        .drop-zone.has-file {
            border-style: solid;
            border-color: var(--accent);
            background: var(--surface);
        }

        .drop-zone-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 12px;
            color: var(--text-muted);
            display: block;
            transition: color 0.2s;
        }

        .drop-zone:hover .drop-zone-icon { color: var(--text-secondary); }
        .drop-zone.dragover .drop-zone-icon { color: var(--accent); }

        .drop-zone-text {
            color: var(--text-secondary);
            font-size: 0.93rem;
            font-weight: 500;
        }

        .drop-zone-hint {
            color: var(--text-muted);
            font-size: 0.78rem;
            margin-top: 5px;
        }

        .file-input { display: none; }

        /* ── Book info ────────────────────────────────────────── */

        .book-info {
            display: none;
            padding: 18px 20px;
            background: var(--bg);
            border-radius: 8px;
            margin-top: 18px;
            animation: fadeSlideUp 0.3s ease;
        }

        .book-info.has-cover { display: flex; gap: 18px; align-items: flex-start; }
        .book-info.no-cover  { display: block; }

        .book-cover {
            width: 72px;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            flex-shrink: 0;
        }

        .book-cover:not([src]), .book-cover[src=""] { display: none; }

        .book-details { flex: 1; min-width: 0; }

        .book-title {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 3px;
            line-height: 1.3;
        }

        .book-author {
            color: var(--text-secondary);
            font-size: 0.88rem;
            font-style: italic;
            margin-bottom: 6px;
        }

        .book-stats {
            color: var(--text-muted);
            font-size: 0.78rem;
        }

        /* ── Chapter list ─────────────────────────────────────── */

        .chapters-card { display: none; }

        .chapter-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chapter-info {
            font-size: 0.82rem;
            color: var(--text-muted);
        }

        .chapter-actions {
            display: flex;
            gap: 14px;
        }

        .chapter-actions button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.82rem;
            font-weight: 500;
            padding: 0;
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .chapter-actions button:hover { color: var(--text); }

        .chapter-list {
            max-height: 280px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .chapter-item {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: background 0.12s;
        }

        .chapter-item:last-child { border-bottom: none; }
        .chapter-item:hover { background: var(--bg); }

        .chapter-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 12px;
            accent-color: var(--accent);
            flex-shrink: 0;
        }

        .chapter-item .title {
            flex: 1;
            font-size: 0.88rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chapter-item .meta {
            font-size: 0.76rem;
            color: var(--text-muted);
            margin-left: 10px;
            white-space: nowrap;
        }

        .badge {
            font-size: 0.62rem;
            padding: 1px 5px;
            border-radius: 3px;
            margin-left: 6px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.02em;
            background: var(--bg);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        /* Duration estimate banner */
        .duration-estimate {
            display: none;
            margin-top: 14px;
            padding: 12px 14px;
            background: var(--bg);
            border-radius: 8px;
            justify-content: space-between;
            align-items: center;
            animation: fadeSlideUp 0.25s ease;
        }

        .duration-estimate-label {
            font-size: 0.83rem;
            color: var(--text-secondary);
        }

        .duration-estimate-right { text-align: right; }

        .duration-estimate-value {
            font-size: 0.93rem;
            font-weight: 600;
            color: var(--text);
        }

        .duration-estimate-note {
            font-size: 0.73rem;
            color: var(--text-muted);
            margin-top: 1px;
        }

        /* ── Options ──────────────────────────────────────────── */

        .options-card { display: none; }

        .option-group {
            margin-bottom: 22px;
        }

        .option-group:last-child { margin-bottom: 0; }

        .option-group-title {
            font-size: 0.72rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .option-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        select {
            flex: 1;
            padding: 10px 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.88rem;
            cursor: pointer;
            transition: border-color 0.15s;
            min-width: 0;
        }

        select:hover  { border-color: var(--text-muted); }
        select:focus  { outline: none; border-color: var(--accent); }

        .voice-row { display: flex; gap: 8px; flex: 1; min-width: 0; }
        .voice-row select { flex: 1; min-width: 0; }

        .preview-btn {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.18s;
        }

        .preview-btn:hover  { border-color: var(--accent); color: var(--accent); }
        .preview-btn.playing { background: var(--accent); border-color: var(--accent); color: var(--surface); }

        /* Speed segmented control */
        .speed-control {
            display: flex;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            flex: 1;
        }

        .speed-control input[type="radio"] { display: none; }

        .speed-control label {
            flex: 1;
            text-align: center;
            padding: 9px 4px;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--surface);
            cursor: pointer;
            border-right: 1px solid var(--border);
            transition: background 0.15s, color 0.15s;
            user-select: none;
        }

        .speed-control label:last-of-type { border-right: none; }

        .speed-control input[type="radio"]:checked + label {
            background: var(--accent);
            color: var(--surface);
        }

        .speed-control label:hover {
            background: var(--bg);
            color: var(--text);
        }

        .speed-control input[type="radio"]:checked + label:hover {
            background: var(--accent);
            color: var(--surface);
        }

        /* Checkboxes */
        .checkbox-option {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            padding: 7px 0;
        }

        .checkbox-option input {
            width: 17px;
            height: 17px;
            accent-color: var(--accent);
            margin-top: 2px;
            flex-shrink: 0;
        }

        .checkbox-label { flex: 1; }

        .checkbox-label-text {
            font-size: 0.88rem;
            color: var(--text);
        }

        .checkbox-label-hint {
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-top: 1px;
        }

        .processing-note {
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-top: 7px;
            padding: 7px 10px;
            background: var(--bg);
            border-radius: 5px;
        }

        .processing-note.ready   { color: var(--text-secondary); }
        .processing-note.warning { color: var(--text-secondary); }

        /* ── Convert button ───────────────────────────────────── */

        .convert-btn {
            width: 100%;
            padding: 15px 24px;
            background: var(--accent);
            color: var(--surface);
            border: none;
            border-radius: 8px;
            font-size: 0.97rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.18s, transform 0.1s;
            margin-top: 24px;
        }

        .convert-btn:hover:not(:disabled) {
            background: var(--accent-hover);
        }

        .convert-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .convert-btn:disabled {
            background: var(--border);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        /* ── Progress section ─────────────────────────────────── */

        .progress-section {
            display: none;
            margin-top: 28px;
            padding-top: 28px;
            border-top: 1px solid var(--border);
            animation: fadeSlideUp 0.3s ease;
        }

        .progress-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.6s ease-in-out;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 14px;
            font-size: 0.84rem;
        }

        .progress-status { color: var(--text); font-weight: 500; }
        .progress-percent { color: var(--text-muted); }

        .progress-details {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 18px;
            padding: 14px;
            background: var(--bg);
            border-radius: 8px;
        }

        .progress-detail { text-align: center; }

        .progress-detail-value {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text);
        }

        .progress-detail-label {
            font-size: 0.67rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 3px;
        }

        /* ── Error ────────────────────────────────────────────── */

        .error {
            color: var(--error);
            font-size: 0.88rem;
            margin-top: 14px;
            padding: 11px 14px;
            background: #fef2f2;
            border-radius: 7px;
            display: none;
            animation: fadeSlideUp 0.2s ease;
        }

        .error:not(:empty) { display: block; }

        /* ── Downloads section ────────────────────────────────── */

        .downloads-section {
            display: none;
            margin-top: 28px;
            padding-top: 28px;
            border-top: 1px solid var(--border);
            animation: fadeSlideUp 0.3s ease;
        }

        .downloads-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 14px;
        }

        .downloads-header h3 {
            font-size: 0.88rem;
            font-weight: 600;
        }

        .success-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: successPop 0.4s ease;
        }

        @keyframes successPop {
            0%   { transform: scale(0); }
            60%  { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .download-list { list-style: none; }

        .download-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 11px 14px;
            background: var(--bg);
            border-radius: 6px;
            margin-bottom: 7px;
            font-size: 0.88rem;
        }

        .download-list a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
        }

        .download-list a:hover { text-decoration: underline; }

        .download-all-btn {
            width: 100%;
            padding: 11px 14px;
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 7px;
            font-size: 0.88rem;
            font-weight: 500;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.15s, border-color 0.15s;
        }

        .download-all-btn:hover {
            background: var(--bg);
            border-color: var(--text-muted);
        }

        /* ── Bitrate note ─────────────────────────────────────── */

        #bitrateNote {
            display: none;
        }

        /* ── History section ──────────────────────────────────── */

        .history-section {
            margin-top: 44px;
            animation: fadeSlideUp 0.35s ease;
        }

        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }

        .history-title {
            font-size: 0.72rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-muted);
        }

        .history-clear-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.78rem;
            padding: 0;
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .history-clear-btn:hover { color: var(--error); }

        .history-entry {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 18px 22px;
            margin-bottom: 10px;
            animation: fadeSlideUp 0.3s ease;
        }

        .history-entry-header { margin-bottom: 10px; }

        .history-entry-title {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.08rem;
            font-weight: 500;
            color: var(--text);
            line-height: 1.3;
        }

        .history-entry-meta {
            font-size: 0.77rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .history-entry-files {
            display: flex;
            flex-wrap: wrap;
            gap: 7px;
        }

        .history-file-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.79rem;
            color: var(--accent);
            text-decoration: none;
            padding: 4px 10px;
            border: 1px solid var(--border);
            border-radius: 5px;
            background: var(--bg);
            transition: border-color 0.15s, background 0.15s;
        }

        .history-file-link:hover {
            border-color: var(--accent);
            background: var(--surface);
        }

        .history-file-expired {
            font-size: 0.79rem;
            color: var(--text-muted);
            padding: 4px 10px;
            border: 1px solid var(--border-subtle);
            border-radius: 5px;
            background: var(--bg);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .history-file-expired .filename {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .expired-badge {
            font-size: 0.62rem;
            padding: 1px 5px;
            border-radius: 3px;
            background: var(--border);
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.04em;
        }

        /* ── Job ETA ──────────────────────────────────────────── */

        .job-eta {
            font-size: 0.72rem;
            color: var(--text-muted);
            min-height: 1em;
            margin-bottom: 2px;
        }

        /* ── Job settings chips ───────────────────────────────── */

        .job-settings-row {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin: 4px 0 6px;
        }

        .job-setting-chip {
            font-size: 0.68rem;
            color: var(--text-secondary);
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1px 7px;
            white-space: nowrap;
        }

        /* ── Footer ───────────────────────────────────────────── */

        footer {
            text-align: center;
            padding: 32px 24px;
            color: var(--text-muted);
            font-size: 0.78rem;
        }

        footer a { color: var(--text-secondary); text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        /* ── Responsive — Desktop (901px+) ────────────────────── */
        /* (default styles above apply at all widths; overrides below) */

        /* ── Responsive — Tablet (601px–900px) ───────────────── */

        @media (max-width: 900px) {
            .page-layout { flex-direction: column; }

            .jobs-sidebar {
                width: 100%;
                padding: 0 24px 32px;
                position: static;
                max-height: none;
                overflow-y: visible;
            }

            .jobs-sidebar-inner { border-radius: 12px; }
        }

        @media (min-width: 601px) and (max-width: 900px) {
            /* On tablet, show sidebar at a reduced but reasonable width inline */
            .jobs-sidebar {
                width: 100%;
                padding: 0 24px 32px;
            }
        }

        /* ── Responsive — Mobile (max-width: 600px) ──────────── */

        @media (max-width: 600px) {
            .container { padding: 20px 14px; }
            .card { padding: 18px 16px; margin-bottom: 14px; }

            /* Header: shrink logo, hide subtitle */
            header { margin-bottom: 24px; }
            .logo { font-size: 1.75rem; margin-bottom: 6px; }
            .intro { display: none; }

            /* Nav tabs: full-width pill row */
            .nav-tabs {
                gap: 0;
                margin-bottom: 24px;
                border: 1px solid var(--border);
                border-radius: 22px;
                overflow: hidden;
                padding: 3px;
                background: var(--bg);
            }
            .nav-tab {
                flex: 1;
                border: none;
                border-radius: 18px;
                padding: 8px 12px;
                font-size: 0.88rem;
                background: transparent;
            }
            .nav-tab.active {
                background: var(--accent);
                color: var(--surface);
            }

            /* Drop zone: less padding, improved touch target */
            .drop-zone { padding: 28px 16px; }
            .drop-zone-icon { width: 36px; height: 36px; margin-bottom: 10px; }
            .drop-zone-text { font-size: 0.9rem; }

            /* Options form: tighten spacing */
            .option-group { margin-bottom: 16px; }
            .option-group-title { margin-bottom: 7px; }
            select { font-size: 0.84rem; padding: 9px 10px; }
            .speed-control label { font-size: 0.74rem; padding: 9px 2px; }

            /* Convert button: full width and more prominent */
            .convert-btn {
                width: 100%;
                padding: 14px 20px;
                font-size: 1rem;
                margin-top: 18px;
            }

            /* Progress details: 2 columns on mobile */
            .progress-details {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            /* Library grid: 1 column below 480px handled separately */
            .library-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .lib-card-title { font-size: 0.92rem; }

            /* Jobs sidebar: no extra side padding */
            .jobs-sidebar { padding: 0 14px 24px; }
        }

        /* ── Responsive — Small mobile (max-width: 480px) ────── */

        @media (max-width: 480px) {
            .library-grid { grid-template-columns: 1fr; gap: 12px; }
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ── Library tab nav ──────────────────────────────────── */

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-bottom: 36px;
        }

        .nav-tab {
            padding: 7px 18px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.84rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s, color 0.15s, border-color 0.15s;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .nav-tab:hover {
            background: var(--bg);
            color: var(--text);
            border-color: var(--text-muted);
        }

        .nav-tab.active {
            background: var(--accent);
            color: var(--surface);
            border-color: var(--accent);
        }

        /* ── Library panel ────────────────────────────────────── */

        .library-panel {
            animation: fadeSlideUp 0.3s ease;
        }

        /* ── Tab panel transitions ─────────────────────────────── */

        .tab-panel {
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .tab-panel.panel-hidden {
            opacity: 0;
            transform: translateY(6px);
            pointer-events: none;
            position: absolute;
            visibility: hidden;
        }
        .tab-panel.panel-visible {
            opacity: 1;
            transform: translateY(0);
            position: relative;
            visibility: visible;
        }

        .library-toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .library-search {
            flex: 1;
            min-width: 180px;
            padding: 9px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--surface);
            color: var(--text);
            font-size: 0.88rem;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            transition: border-color 0.15s;
        }

        .library-search:focus {
            outline: none;
            border-color: var(--accent);
        }

        .library-search::placeholder { color: var(--text-muted); }

        .library-refresh-btn {
            padding: 9px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--surface);
            color: var(--text-secondary);
            font-size: 0.84rem;
            font-weight: 500;
            cursor: pointer;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            transition: border-color 0.15s, color 0.15s;
            white-space: nowrap;
        }

        .library-refresh-btn:hover {
            border-color: var(--text-muted);
            color: var(--text);
        }

        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }

        /* ── Library book cards ───────────────────────────────── */

        .lib-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.18s;
            animation: fadeSlideUp 0.3s ease both;
        }

        .lib-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.07); }

        @keyframes libCardFadeOut {
            from { opacity: 1; transform: scale(1); }
            to   { opacity: 0; transform: scale(0.95); }
        }

        .lib-card.removing {
            animation: libCardFadeOut 0.25s ease forwards;
        }

        .lib-card-cover {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
            background: var(--bg);
            display: block;
        }

        .lib-card-cover-placeholder {
            width: 100%;
            aspect-ratio: 2/3;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--border);
        }

        .lib-card-body {
            padding: 14px 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .lib-card-title {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.05rem;
            font-weight: 500;
            line-height: 1.3;
            color: var(--text);
            margin-bottom: 3px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .lib-card-author {
            font-size: 0.79rem;
            color: var(--text-muted);
            font-style: italic;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lib-card-duration {
            font-size: 1.0rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .lib-card-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .lib-format-badge {
            font-size: 0.62rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text-muted);
        }

        .lib-card-size {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .lib-card-date {
            font-size: 0.74rem;
            color: var(--text-muted);
            margin-top: auto;
            padding-top: 6px;
        }

        .lib-card-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 0 16px 14px;
        }

        .lib-download-btn {
            display: block;
            width: 100%;
            padding: 8px 12px;
            background: var(--accent);
            color: var(--surface);
            border: none;
            border-radius: 6px;
            font-size: 0.82rem;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            transition: background 0.15s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lib-download-btn:hover { background: var(--accent-hover); }

        .lib-delete-btn {
            width: 100%;
            padding: 7px 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.82rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            transition: border-color 0.15s, color 0.15s;
        }

        .lib-delete-btn:hover { border-color: var(--error); color: var(--error); }

        .lib-delete-confirm {
            display: none;
            align-items: center;
            gap: 6px;
        }

        .lib-delete-confirm.visible { display: flex; }

        .lib-delete-confirm span {
            font-size: 0.78rem;
            color: var(--text-secondary);
            flex: 1;
        }

        .lib-confirm-yes {
            padding: 5px 10px;
            background: var(--error);
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .lib-confirm-no {
            padding: 5px 10px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            border-radius: 5px;
            font-size: 0.78rem;
            font-weight: 500;
            cursor: pointer;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Library empty / loading states */
        .library-empty {
            text-align: center;
            padding: 60px 24px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .library-empty svg {
            width: 48px;
            height: 48px;
            color: var(--border);
            margin: 0 auto 16px;
            display: block;
        }

        .library-empty p { margin-top: 6px; font-size: 0.84rem; }
    </style>
</head>
<body>
    <div class="page-layout">

        <!-- ── Main column ─────────────────────────────────────── -->
        <div class="main-column">
            <div class="container">

                <header>
                    <h1 class="logo">Inkvoice</h1>
                    <p class="intro">
                        Convert any EPUB into a high-quality audiobook.
                        AI-powered text-to-speech that actually sounds good.
                    </p>
                </header>

                <!-- ── Tab navigation ──────────────────────────── -->
                <nav class="nav-tabs">
                    <button class="nav-tab active" id="tabConvert" onclick="switchTab('convert')">Convert</button>
                    <button class="nav-tab" id="tabLibrary" onclick="switchTab('library')">Library</button>
                </nav>

                <!-- ── Convert panel ───────────────────────────── -->
                <div id="convertPanel" class="tab-panel panel-visible">

                <!-- Step 1: Upload -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-number">1</span>
                        <span class="card-title">Choose your book</span>
                    </div>

                    <div class="drop-zone" id="dropZone">
                        <svg class="drop-zone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                        </svg>
                        <p class="drop-zone-text">Drop your EPUB here or click to browse</p>
                        <p class="drop-zone-hint">EPUB files only</p>
                        <input type="file" class="file-input" id="epubInput" accept=".epub">
                    </div>

                    <div class="book-info" id="bookInfo">
                        <img class="book-cover" id="bookCover" src="" alt="">
                        <div class="book-details">
                            <div class="book-title" id="bookTitle"></div>
                            <div class="book-author" id="bookAuthor"></div>
                            <div class="book-stats" id="bookStats"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Chapters -->
                <div class="card chapters-card" id="chaptersCard">
                    <div class="card-header">
                        <span class="card-number">2</span>
                        <span class="card-title">Select chapters</span>
                    </div>

                    <div class="chapter-controls">
                        <span class="chapter-info" id="selectionStats"></span>
                        <div class="chapter-actions">
                            <button onclick="selectAll()">Select all</button>
                            <button onclick="selectNone()">Clear</button>
                        </div>
                    </div>

                    <div class="chapter-list" id="chapterList"></div>

                    <div class="duration-estimate" id="durationEstimate">
                        <span class="duration-estimate-label">Estimated listening time</span>
                        <div class="duration-estimate-right">
                            <div class="duration-estimate-value" id="durationEstimateValue"></div>
                            <div class="duration-estimate-note" id="durationEstimateNote"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Options -->
                <div class="card options-card" id="optionsCard">
                    <div class="card-header">
                        <span class="card-number">3</span>
                        <span class="card-title">Configure output</span>
                    </div>

                    <div class="option-group">
                        <div class="option-group-title">Voice</div>
                        <div class="option-row">
                            <div class="voice-row">
                                <select id="voiceSelect"></select>
                                <button type="button" class="preview-btn" id="previewBtn" title="Preview voice">
                                    <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="option-group">
                        <div class="option-group-title">Format</div>
                        <div class="option-row">
                            <select id="formatSelect">
                                <option value="mp3">MP3 (separate files per chapter)</option>
                                <option value="m4b" id="m4bOption" selected disabled>M4B audiobook (single file with chapters)</option>
                            </select>
                        </div>
                    </div>

                    <div class="option-group">
                        <div class="option-group-title">Audio quality</div>
                        <div class="option-row">
                            <select id="bitrateSelect">
                                <option value="64">64 kbps — small file</option>
                                <option value="128" selected>128 kbps — standard</option>
                                <option value="192">192 kbps — high quality</option>
                            </select>
                        </div>
                        <div class="processing-note" id="bitrateNote"></div>
                    </div>

                    <div class="option-group">
                        <div class="option-group-title">Narration speed</div>
                        <div class="option-row">
                            <div class="speed-control">
                                <input type="radio" name="speed" id="speed075" value="0.75">
                                <label for="speed075">0.75×</label>
                                <input type="radio" name="speed" id="speed100" value="1.0" checked>
                                <label for="speed100">1×</label>
                                <input type="radio" name="speed" id="speed125" value="1.25">
                                <label for="speed125">1.25×</label>
                                <input type="radio" name="speed" id="speed150" value="1.5">
                                <label for="speed150">1.5×</label>
                                <input type="radio" name="speed" id="speed200" value="2.0">
                                <label for="speed200">2×</label>
                            </div>
                        </div>
                    </div>

                    <div class="option-group">
                        <div class="option-group-title">Text processing</div>
                        <div class="option-row">
                            <select id="textProcessingSelect">
                                <option value="none">Original text</option>
                                <option value="clean">Narration-ready (remove footnotes, references)</option>
                                <option value="speed">Condensed (~30% shorter)</option>
                                <option value="summary">Key points only (~10%)</option>
                            </select>
                        </div>
                        <div class="processing-note" id="processingNote" style="display:none;"></div>
                    </div>

                    <div class="option-group">
                        <div class="option-group-title">Options</div>
                        <label class="checkbox-option">
                            <input type="checkbox" id="announceChapters">
                            <div class="checkbox-label">
                                <div class="checkbox-label-text">Announce chapter titles</div>
                                <div class="checkbox-label-hint">Voice reads the chapter name at the start</div>
                            </div>
                        </label>
                        <label class="checkbox-option" id="perChapterOption">
                            <input type="checkbox" id="perChapter" checked>
                            <div class="checkbox-label">
                                <div class="checkbox-label-text">One file per chapter</div>
                                <div class="checkbox-label-hint">Creates separate MP3 files for each chapter</div>
                            </div>
                        </label>
                    </div>

                    <button class="convert-btn" id="convertBtn" disabled>Select an EPUB to begin</button>

                    <div class="error" id="errorText"></div>

                    <!-- Progress -->
                    <div class="progress-section" id="progressSection">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-info">
                            <span class="progress-status" id="progressStatus">Starting...</span>
                            <span class="progress-percent" id="progressPercent">0%</span>
                        </div>
                        <div class="progress-details">
                            <div class="progress-detail">
                                <div class="progress-detail-value" id="progressChapter">-</div>
                                <div class="progress-detail-label">Chapter</div>
                            </div>
                            <div class="progress-detail">
                                <div class="progress-detail-value" id="progressElapsed">0:00</div>
                                <div class="progress-detail-label">Elapsed</div>
                            </div>
                            <div class="progress-detail">
                                <div class="progress-detail-value" id="progressRemaining">--:--</div>
                                <div class="progress-detail-label">Remaining</div>
                            </div>
                            <div class="progress-detail">
                                <div class="progress-detail-value" id="progressWords">-</div>
                                <div class="progress-detail-label">Words <span id="progressRate" style="font-size:0.75em;opacity:0.7;"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Downloads -->
                    <div class="downloads-section" id="downloadsSection">
                        <div class="downloads-header">
                            <span class="success-dot"></span>
                            <h3>Ready for download</h3>
                        </div>
                        <ul class="download-list" id="downloadList"></ul>
                        <button class="download-all-btn" id="downloadAllBtn" style="display:none;">Download all as ZIP</button>
                    </div>
                </div>

                <!-- Job History -->
                <div class="history-section" id="historySection" style="display:none;">
                    <div class="history-header">
                        <span class="history-title">Recent Conversions</span>
                        <button class="history-clear-btn" id="historyClearBtn">Clear history</button>
                    </div>
                    <div id="historyList"></div>
                </div>

                </div><!-- end #convertPanel -->

                <!-- ── Library panel ───────────────────────────── -->
                <div class="library-panel tab-panel panel-hidden" id="libraryPanel">

                    <div class="library-toolbar">
                        <input class="library-search" id="librarySearch" type="search"
                               placeholder="Search by title or author…" oninput="filterLibrary()">
                        <button class="library-refresh-btn" onclick="loadLibrary()">Refresh</button>
                    </div>

                    <div class="library-grid" id="libraryGrid">
                        <!-- Cards rendered by JS -->
                    </div>

                </div><!-- end #libraryPanel -->

            </div>

            <footer>
                Powered by <a href="https://github.com/remsky/Kokoro-FastAPI" target="_blank">Kokoro TTS</a>
                and <a href="https://ai.google.dev/" target="_blank">Gemini</a>
            </footer>
        </div>

        <!-- ── Jobs sidebar ────────────────────────────────────── -->
        <aside class="jobs-sidebar" id="jobsSidebar">
            <div class="jobs-sidebar-inner">
                <div class="jobs-sidebar-header">
                    <span class="jobs-sidebar-title">Jobs</span>
                    <span class="jobs-count-badge" id="jobsCountBadge">0</span>
                </div>
                <div class="jobs-list" id="jobsList"></div>
            </div>
        </aside>

    </div><!-- end .page-layout -->

    <script>
        // ── Element refs ─────────────────────────────────────────
        const dropZone            = document.getElementById('dropZone');
        const epubInput           = document.getElementById('epubInput');
        const bookInfo            = document.getElementById('bookInfo');
        const bookCover           = document.getElementById('bookCover');
        const bookTitle           = document.getElementById('bookTitle');
        const bookAuthor          = document.getElementById('bookAuthor');
        const bookStats           = document.getElementById('bookStats');
        const chaptersCard        = document.getElementById('chaptersCard');
        const chapterList         = document.getElementById('chapterList');
        const selectionStats      = document.getElementById('selectionStats');
        const optionsCard         = document.getElementById('optionsCard');
        const voiceSelect         = document.getElementById('voiceSelect');
        const formatSelect        = document.getElementById('formatSelect');
        const bitrateSelect       = document.getElementById('bitrateSelect');
        const m4bOption           = document.getElementById('m4bOption');
        const textProcessingSelect= document.getElementById('textProcessingSelect');
        const processingNote      = document.getElementById('processingNote');
        const announceChapters    = document.getElementById('announceChapters');
        const perChapter          = document.getElementById('perChapter');
        const perChapterOption    = document.getElementById('perChapterOption');
        const convertBtn          = document.getElementById('convertBtn');
        const errorText           = document.getElementById('errorText');
        const progressSection     = document.getElementById('progressSection');
        const progressFill        = document.getElementById('progressFill');
        const progressStatus      = document.getElementById('progressStatus');
        const progressPercent     = document.getElementById('progressPercent');
        const progressChapter     = document.getElementById('progressChapter');
        const progressElapsed     = document.getElementById('progressElapsed');
        const progressRemaining   = document.getElementById('progressRemaining');
        const progressWords       = document.getElementById('progressWords');
        const progressRate        = document.getElementById('progressRate');
        const downloadsSection    = document.getElementById('downloadsSection');
        const downloadList        = document.getElementById('downloadList');
        const downloadAllBtn      = document.getElementById('downloadAllBtn');
        const previewBtn          = document.getElementById('previewBtn');
        const jobsSidebar         = document.getElementById('jobsSidebar');
        const jobsList            = document.getElementById('jobsList');
        const jobsCountBadge      = document.getElementById('jobsCountBadge');

        // ── State ────────────────────────────────────────────────
        let uploadId       = null;
        let chapters       = [];
        let m4bAvailable   = false;
        let geminiAvailable= false;
        let ttsAvailable   = false;
        let previewAudio   = null;
        let voiceData      = [];
        let primaryJobId   = null;

        // Duration estimate constants
        const WORDS_PER_MINUTE = 150;
        const PROCESSING_MULTIPLIERS = {
            none: 1.0, clean: 1.0, speed: 0.3, summary: 0.1,
        };

        function getProcessingMultiplier() {
            return PROCESSING_MULTIPLIERS[textProcessingSelect.value] || 1.0;
        }

        function formatDuration(words, multiplier) {
            if (multiplier === undefined) multiplier = getProcessingMultiplier();
            const totalMins = Math.round(words * multiplier / WORDS_PER_MINUTE);
            const h = Math.floor(totalMins / 60), m = totalMins % 60;
            return h > 0 ? `${h}h ${m}m` : `${totalMins}m`;
        }

        function formatChapterDuration(words) {
            const mins = Math.round(words * getProcessingMultiplier() / WORDS_PER_MINUTE);
            return mins < 1 ? '<1m' : `~${mins}m`;
        }

        function formatWords(n) {
            return n >= 1000 ? `${(n/1000).toFixed(1)}k` : String(n);
        }

        function formatTime(seconds) {
            if (seconds == null || isNaN(seconds)) return '--:--';
            const m = Math.floor(seconds / 60), s = Math.floor(seconds % 60);
            return `${m}:${String(s).padStart(2, '0')}`;
        }

        function formatEta(seconds) {
            if (seconds == null || isNaN(seconds)) return '';
            if (seconds >= 3600) {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                return `~${h}h ${m}m remaining`;
            }
            if (seconds >= 60) {
                const m = Math.floor(seconds / 60);
                const s = Math.floor(seconds % 60);
                return `~${m}m ${s}s remaining`;
            }
            return `~${Math.floor(seconds)}s remaining`;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                      .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
        }

        // ── Icons ────────────────────────────────────────────────
        const playIcon    = '<svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
        const stopIcon    = '<svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12"/></svg>';
        const loadingIcon = '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" opacity="0.3"/><path d="M12 2a10 10 0 0 1 10 10"><animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/></path></svg>';

        // ── Job queue ────────────────────────────────────────────

        // Map jobId → { id, title, status, progress, message, files, cardEl }
        const jobQueue = new Map();

        function renderSettingsChips(settings) {
            if (!settings || Object.keys(settings).length === 0) return '';
            const chips = [];
            if (settings.voice) chips.push(escapeHtml(settings.voice));
            if (settings.output_format) chips.push(settings.output_format.toUpperCase());
            if (settings.speed && settings.speed !== 1.0) chips.push(`${settings.speed}×`);
            if (settings.text_processing && settings.text_processing !== 'none') chips.push(escapeHtml(settings.text_processing));
            if (settings.bitrate) chips.push(`${settings.bitrate}kbps`);
            return chips.map(c => `<span class="job-setting-chip">${c}</span>`).join('');
        }

        function addJob(jobId, title, opts = {}) {
            const author   = opts.author   || '';
            const settings = opts.settings || {};
            const status   = opts.status   || 'processing';
            const progress = opts.progress || 0;
            const chipsHtml = renderSettingsChips(settings);
            const card = document.createElement('div');
            card.className = 'job-card';
            card.id = `job-${jobId}`;
            card.innerHTML = `
                <div class="job-card-header">
                    <span class="job-status-dot ${status === 'processing' ? 'processing' : status}" id="dot-${jobId}"></span>
                    <div class="job-card-title" title="${escapeHtml(title)}">${escapeHtml(title)}</div>
                    <span class="job-pct" id="pct-${jobId}">${progress}%</span>
                </div>
                <div class="job-card-info">
                    ${author ? `<div class="job-card-author">${escapeHtml(author)}</div>` : ''}
                    <div class="job-card-status" id="st-${jobId}">${status === 'processing' ? 'Starting…' : (status === 'complete' ? 'Complete' : status)}</div>
                    <div class="job-eta" id="eta-${jobId}"></div>
                </div>
                <div class="job-progress-bar">
                    <div class="job-progress-fill" id="fill-${jobId}" style="width:${progress}%"></div>
                </div>
                <div class="job-settings-row" id="chips-${jobId}">${chipsHtml}</div>
                <div class="job-summary-row" id="summary-${jobId}"></div>
                <div class="job-downloads" id="dl-${jobId}">
                    <div class="job-download-links" id="links-${jobId}"></div>
                </div>
                <div class="job-error-msg" id="err-${jobId}"></div>
                <div class="job-card-footer">
                    <button class="job-cancel-btn visible" id="cancel-${jobId}" title="Cancel this job">Cancel</button>
                    <button class="job-resume-btn" id="resume-${jobId}" title="Resume from last checkpoint">Resume</button>
                </div>
            `;

            jobsList.insertBefore(card, jobsList.firstChild);

            // Wire cancel button
            card.querySelector(`#cancel-${jobId}`).addEventListener('click', () => cancelJob(jobId));
            // Wire resume button
            card.querySelector(`#resume-${jobId}`).addEventListener('click', () => resumeJob(jobId));

            jobQueue.set(jobId, { id: jobId, title, author, settings, status, progress, files: [] });

            // Make this the primary job shown in the main progress section
            primaryJobId = jobId;
            progressSection.style.display = 'block';
            progressFill.style.width = '0%';
            progressStatus.textContent = 'Starting…';
            progressPercent.textContent = '0%';
            progressChapter.textContent = '-';
            progressElapsed.textContent = '0:00';
            progressRemaining.textContent = '--:--';
            progressWords.textContent = '-';
            progressRate.textContent = '';

            syncJobsUI();
            return card;
        }

        async function cancelJob(jobId) {
            const btn = document.getElementById(`cancel-${jobId}`);
            if (btn) { btn.disabled = true; btn.textContent = 'Cancelling…'; }
            try {
                await fetch(`/api/cancel/${jobId}`, { method: 'DELETE' });
            } catch (_) {}
        }

        async function resumeJob(jobId) {
            const btn = document.getElementById(`resume-${jobId}`);
            if (btn) { btn.disabled = true; btn.textContent = 'Resuming…'; }
            try {
                const response = await fetch(`/api/resume/${jobId}`, { method: 'POST' });
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    alert(`Resume failed: ${err.detail || response.statusText}`);
                    if (btn) { btn.disabled = false; btn.textContent = 'Resume'; }
                    return;
                }
                const data = await response.json();
                const newJobId = data.new_job_id;
                const chaptersDone = data.chapters_done || 0;

                // Get title from the original job card
                const origCard = document.getElementById(`job-${jobId}`);
                const origTitle = origCard
                    ? origCard.querySelector('.job-card-title').textContent
                    : 'Resuming…';

                addJob(newJobId, origTitle);
                listenForProgress(newJobId);

                // Show toast with resume info
                showToast(`Resuming from chapter ${chaptersDone + 1}…`);

                if (btn) { btn.classList.remove('visible'); }
            } catch (e) {
                alert(`Resume error: ${e.message}`);
                if (btn) { btn.disabled = false; btn.textContent = 'Resume'; }
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = [
                'position:fixed', 'bottom:24px', 'left:50%', 'transform:translateX(-50%)',
                'background:#171717', 'color:#fff', 'font-size:0.85rem', 'font-weight:500',
                'padding:10px 20px', 'border-radius:8px', 'z-index:9999',
                'animation:fadeSlideUp 0.3s ease', 'pointer-events:none',
            ].join(';');
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function updatePrimaryProgress(data) {
            const d = data.details || {};
            progressFill.style.width    = `${data.progress}%`;
            progressPercent.textContent = `${Math.round(data.progress)}%`;
            progressStatus.textContent  = data.message || '';

            const ch = d.chapter_current, ct = d.chapter_total;
            progressChapter.textContent = (ch && ct) ? `${ch} / ${ct}` : '-';

            progressElapsed.textContent   = formatTime(d.elapsed_seconds);
            progressRemaining.textContent = formatTime(d.estimated_remaining_seconds);

            const wp = d.words_processed, wt = d.words_total;
            if (wp != null && wt != null && wt > 0) {
                progressWords.textContent = `${formatWords(wp)} / ${formatWords(wt)}`;
            } else if (wt != null && wt > 0) {
                progressWords.textContent = formatWords(wt);
            } else {
                progressWords.textContent = '-';
            }

            const wps = d.words_per_sec;
            progressRate.textContent = wps != null ? `~${wps} w/s` : '';

            if (data.status === 'complete') {
                progressFill.style.width    = '100%';
                progressPercent.textContent = '100%';
                progressStatus.textContent  = 'Complete';
            } else if (data.status === 'error') {
                progressStatus.textContent = 'Failed';
            } else if (data.status === 'cancelled') {
                progressStatus.textContent = 'Cancelled';
            }
        }

        function formatConversionTime(secs) {
            if (!secs) return '';
            const m = Math.floor(secs / 60), s = secs % 60;
            return m > 0 ? `${m}m ${s}s` : `${s}s`;
        }

        function updateJobCard(jobId, data) {
            const job = jobQueue.get(jobId);
            if (!job) return;

            job.status   = data.status;
            job.progress = data.progress;
            job.message  = data.message;
            if (data.files) job.files = data.files;
            if (data.can_resume !== undefined) job.can_resume = data.can_resume;

            // Promote title/author from details if not yet set
            if (data.details) {
                if (data.details.book_title && !job.title) {
                    job.title = data.details.book_title;
                    job.author = data.details.book_author || '';
                    const titleEl = document.querySelector(`#job-${jobId} .job-card-title`);
                    if (titleEl) { titleEl.textContent = job.title; titleEl.title = job.title; }
                    // Inject author if not already present
                    const infoEl = document.querySelector(`#job-${jobId} .job-card-info`);
                    if (infoEl && job.author && !infoEl.querySelector('.job-card-author')) {
                        const authorEl = document.createElement('div');
                        authorEl.className = 'job-card-author';
                        authorEl.textContent = job.author;
                        infoEl.insertBefore(authorEl, infoEl.querySelector('.job-card-status'));
                    }
                }
            }

            // Update settings chips if we now have settings
            if (data.settings && (!job.settings || Object.keys(job.settings).length === 0)) {
                job.settings = data.settings;
                const chipsEl = document.getElementById(`chips-${jobId}`);
                if (chipsEl) chipsEl.innerHTML = renderSettingsChips(data.settings);
            }

            // Mirror to main progress section if this is the primary job
            if (jobId === primaryJobId) updatePrimaryProgress(data);

            const dot       = document.getElementById(`dot-${jobId}`);
            const st        = document.getElementById(`st-${jobId}`);
            const fill      = document.getElementById(`fill-${jobId}`);
            const pct       = document.getElementById(`pct-${jobId}`);
            const dlEl      = document.getElementById(`dl-${jobId}`);
            const links     = document.getElementById(`links-${jobId}`);
            const errEl     = document.getElementById(`err-${jobId}`);
            const cancelBtn = document.getElementById(`cancel-${jobId}`);
            const resumeBtn = document.getElementById(`resume-${jobId}`);

            if (!dot) return;

            fill.style.width = `${data.progress}%`;
            pct.textContent  = `${Math.round(data.progress)}%`;

            // ETA element (always look it up — may not exist in older cards)
            const etaEl = document.getElementById(`eta-${jobId}`);

            if (data.status === 'processing') {
                dot.className  = 'job-status-dot processing';
                st.className   = 'job-card-status';
                st.textContent = data.message;
                fill.className = 'job-progress-fill';
                if (resumeBtn) resumeBtn.classList.remove('visible');

                // Show ETA once we have a reliable estimate (elapsed > 30s)
                if (etaEl) {
                    const d = data.details || {};
                    const remaining = d.estimated_remaining_seconds;
                    const elapsed = d.elapsed_seconds || 0;
                    if (remaining != null && elapsed > 30) {
                        etaEl.textContent = formatEta(remaining);
                    } else {
                        etaEl.textContent = '';
                    }
                }

            } else if (data.status === 'complete') {
                dot.className  = 'job-status-dot complete';
                st.className   = 'job-card-status';
                st.textContent = 'Complete';
                pct.textContent= '100%';
                fill.style.width  = '100%';
                fill.className = 'job-progress-fill complete';
                if (etaEl) etaEl.textContent = '';

                if (cancelBtn) { cancelBtn.classList.remove('visible'); }
                if (resumeBtn) { resumeBtn.classList.remove('visible'); }

                // Show completion summary
                if (summaryEl && data.summary) {
                    const s = data.summary;
                    const parts = [];
                    if (s.chapter_count) parts.push(`${s.chapter_count} chapter${s.chapter_count !== 1 ? 's' : ''}`);
                    if (s.conversion_time_seconds) parts.push(formatConversionTime(s.conversion_time_seconds));
                    if (parts.length) { summaryEl.textContent = parts.join(' · '); summaryEl.classList.add('visible'); }
                }

                if (data.files && data.files.length > 0) {
                    links.innerHTML = '';
                    data.files.forEach(file => {
                        const a = document.createElement('a');
                        a.className  = 'job-download-link';
                        a.href       = `/api/download/${jobId}/${encodeURIComponent(file)}`;
                        a.download   = file;
                        a.textContent= file;
                        a.title      = file;
                        links.appendChild(a);
                    });
                    if (data.files.length > 1) {
                        const allA = document.createElement('a');
                        allA.className   = 'job-download-all-link';
                        allA.href        = `/api/download-all/${jobId}`;
                        allA.textContent = 'Download all as ZIP';
                        links.appendChild(allA);
                    }
                }
                dlEl.classList.add('visible');

            } else if (data.status === 'error') {
                dot.className  = 'job-status-dot error';
                st.className   = 'job-card-status error-text';
                st.textContent = 'Failed';
                fill.className = 'job-progress-fill error';
                pct.textContent= '';
                if (etaEl) etaEl.textContent = '';
                if (errEl) { errEl.textContent = data.message; errEl.classList.add('visible'); }
                if (cancelBtn) { cancelBtn.classList.remove('visible'); }
                if (resumeBtn && data.can_resume) { resumeBtn.classList.add('visible'); }

            } else if (data.status === 'cancelled') {
                dot.className  = 'job-status-dot cancelled';
                st.className   = 'job-card-status';
                st.textContent = 'Cancelled';
                fill.className = 'job-progress-fill';
                pct.textContent= '';
                if (etaEl) etaEl.textContent = '';
                if (cancelBtn) { cancelBtn.classList.remove('visible'); }
                if (resumeBtn && data.can_resume) { resumeBtn.classList.add('visible'); }
            }

            syncJobsUI();
        }

        function syncJobsUI() {
            const count = jobQueue.size;
            jobsCountBadge.textContent = count;
            if (count > 0) jobsSidebar.classList.add('visible');
        }

        // ── SSE listener ─────────────────────────────────────────

        // ── Browser notifications ─────────────────────────────────
        function notifyJobDone(title, body) {
            if (Notification.permission !== 'granted') return;
            try {
                new Notification(title, { body, icon: '/static/favicon.svg' });
            } catch (e) { /* Safari sometimes throws on icon URL */ }
        }

        function listenForProgress(jobId) {
            const es = new EventSource(`/api/progress/${jobId}`);

            es.onmessage = (event) => {
                const data = JSON.parse(event.data);
                updateJobCard(jobId, data);
                if (data.status === 'complete' || data.status === 'error' || data.status === 'cancelled') {
                    es.close();
                    const job = jobQueue.get(jobId);
                    const bookTitle = job?.title || 'Audiobook';
                    if (data.status === 'complete') {
                        notifyJobDone(`✅ ${bookTitle}`, 'Ready to download');
                    } else if (data.status === 'error') {
                        notifyJobDone(`❌ ${bookTitle}`, data.message || 'Conversion failed');
                    }
                }
            };

            es.onerror = () => {
                es.close();
                const job = jobQueue.get(jobId);
                if (job && job.status === 'processing') {
                    updateJobCard(jobId, { status: 'error', progress: 0, message: 'Connection lost', files: [] });
                }
            };
        }

        // ── Capabilities & voices ────────────────────────────────

        async function loadCapabilities() {
            try {
                const data = await fetch('/api/capabilities').then(r => r.json());
                m4bAvailable = data.formats.m4b;
                m4bOption.disabled   = !m4bAvailable;
                m4bOption.textContent = m4bAvailable
                    ? 'M4B audiobook (single file with chapters)'
                    : 'M4B (requires ffmpeg — not installed)';

                geminiAvailable = data.gemini_available;
                ttsAvailable    = data.tts_available;

                if (geminiAvailable) {
                    textProcessingSelect.value = 'clean';
                    processingNote.style.display = 'block';
                    processingNote.className = 'processing-note ready';
                    processingNote.textContent = 'Gemini removes footnotes, URLs, and non-spoken content';
                }

                if (!ttsAvailable) {
                    convertBtn.textContent = 'TTS not available';
                    showError('TTS engine not configured. Please check installation.');
                }
            } catch (e) {
                console.error('Failed to load capabilities:', e);
            }
        }

        async function loadVoices() {
            try {
                const data = await fetch('/api/voices').then(r => r.json());
                voiceData = data.voices;
                voiceSelect.innerHTML = '';

                const groups = {
                    narration: { label: 'Narration', voices: [] },
                    casual:    { label: 'Casual',    voices: [] },
                    neutral:   { label: 'Neutral',   voices: [] },
                };

                voiceData.forEach(v => {
                    (groups[v.best_for] || groups.neutral).voices.push(v);
                });

                for (const [, group] of Object.entries(groups)) {
                    if (group.voices.length === 0) continue;
                    const og = document.createElement('optgroup');
                    og.label = group.label;
                    group.voices.forEach(v => {
                        const opt = document.createElement('option');
                        opt.value = v.name;
                        opt.textContent = `${v.name} — ${v.characteristic}`;
                        if (v.name === data.default) opt.selected = true;
                        og.appendChild(opt);
                    });
                    voiceSelect.appendChild(og);
                }
            } catch (e) {
                console.error('Failed to load voices:', e);
            }
        }

        loadCapabilities();
        loadVoices();

        // ── Bitrate note ─────────────────────────────────────────

        function updateBitrateNote() {
            const selected = getSelectedChapters();
            const words = selected.reduce((s, i) => s + chapters[i].words, 0);
            const mins = words / WORDS_PER_MINUTE;
            const bitrate = parseInt(bitrateSelect.value);
            const sizeMB = (bitrate * 1000 / 8 * mins * 60) / (1024 * 1024);
            const note = document.getElementById('bitrateNote');
            if (mins > 0) {
                note.textContent = `Estimated file size: ~${sizeMB.toFixed(0)} MB for ~${Math.round(mins)} min of audio`;
                note.style.display = 'block';
            } else {
                note.style.display = 'none';
            }
        }

        bitrateSelect.addEventListener('change', updateBitrateNote);

        // ── Text processing note ──────────────────────────────────

        textProcessingSelect.addEventListener('change', () => {
            const mode = textProcessingSelect.value;
            if (mode === 'none') {
                processingNote.style.display = 'none';
            } else if (mode === 'clean') {
                processingNote.style.display = 'block';
                processingNote.className = 'processing-note ' + (geminiAvailable ? 'ready' : 'warning');
                processingNote.textContent = geminiAvailable
                    ? 'Gemini removes footnotes, URLs, and non-spoken content'
                    : 'Gemini not configured — basic cleanup only';
            } else if (mode === 'speed') {
                processingNote.style.display = 'block';
                processingNote.className = 'processing-note ' + (geminiAvailable ? 'ready' : 'warning');
                processingNote.textContent = geminiAvailable
                    ? 'Gemini condenses while preserving key information'
                    : 'Requires Gemini API key';
            } else {
                processingNote.style.display = 'block';
                processingNote.className = 'processing-note ' + (geminiAvailable ? 'ready' : 'warning');
                processingNote.textContent = geminiAvailable
                    ? 'Gemini extracts main ideas and conclusions'
                    : 'Requires Gemini API key';
            }
            updateSelectionStats();
            // Refresh per-chapter durations
            chapterList.querySelectorAll('.chapter-item').forEach((item, i) => {
                const meta = item.querySelector('.meta');
                if (meta && chapters[i]) {
                    meta.textContent = `${formatWords(chapters[i].words)} · ${formatChapterDuration(chapters[i].words)}`;
                }
            });
        });

        // ── Format change ─────────────────────────────────────────

        formatSelect.addEventListener('change', () => {
            const isM4B = formatSelect.value === 'm4b';
            perChapterOption.style.opacity = isM4B ? '0.5' : '1';
            perChapter.disabled = isM4B;
            if (isM4B) perChapter.checked = false;
            updateConvertBtn();
        });

        function updateConvertBtn() {
            if (uploadId) {
                convertBtn.textContent = `Convert to ${formatSelect.value.toUpperCase()}`;
            }
        }

        // ── Voice preview ─────────────────────────────────────────

        previewBtn.addEventListener('click', async () => {
            if (previewAudio && !previewAudio.paused) {
                previewAudio.pause();
                previewAudio.currentTime = 0;
                previewBtn.innerHTML = playIcon;
                previewBtn.classList.remove('playing');
                return;
            }
            previewBtn.disabled = true;
            previewBtn.innerHTML = loadingIcon;
            try {
                if (!previewAudio) {
                    previewAudio = new Audio();
                    previewAudio.addEventListener('ended', () => {
                        previewBtn.innerHTML = playIcon;
                        previewBtn.classList.remove('playing');
                    });
                }
                previewAudio.src = `/api/voice-preview/${voiceSelect.value}`;
                await previewAudio.play();
                previewBtn.innerHTML = stopIcon;
                previewBtn.classList.add('playing');
            } catch (e) {
                console.error('Preview failed:', e);
                previewBtn.innerHTML = playIcon;
            }
            previewBtn.disabled = false;
        });

        voiceSelect.addEventListener('change', () => {
            if (previewAudio && !previewAudio.paused) {
                previewAudio.pause();
                previewBtn.innerHTML = playIcon;
                previewBtn.classList.remove('playing');
            }
        });

        // ── File upload / drop ────────────────────────────────────

        dropZone.addEventListener('click', () => epubInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length && e.dataTransfer.files[0].name.endsWith('.epub')) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        epubInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });

        async function handleFile(file) {
            dropZone.classList.add('has-file');
            dropZone.querySelector('.drop-zone-text').textContent = 'Parsing…';
            dropZone.querySelector('.drop-zone-hint').textContent = file.name;
            clearError();

            const formData = new FormData();
            formData.append('epub_file', file);

            try {
                const response = await fetch('/api/upload', { method: 'POST', body: formData });
                if (!response.ok) throw new Error('Failed to parse EPUB');

                const data = await response.json();
                uploadId = data.upload_id;
                chapters = data.chapters;

                bookTitle.textContent  = data.title;
                bookAuthor.textContent = data.author ? `by ${data.author}` : '';

                const totalMins = Math.round(data.total_words / WORDS_PER_MINUTE);
                const h = Math.floor(totalMins / 60), m = totalMins % 60;
                const duration = h > 0 ? `~${h}h ${m}m` : `~${m} min`;
                bookStats.textContent = `${data.total_words.toLocaleString()} words · ${duration} audio`;

                if (data.has_cover) {
                    bookCover.src = `/api/cover/${uploadId}`;
                    bookInfo.className = 'book-info has-cover';
                } else {
                    bookCover.src = '';
                    bookInfo.className = 'book-info no-cover';
                }

                dropZone.querySelector('.drop-zone-text').textContent = file.name;
                dropZone.querySelector('.drop-zone-hint').textContent = 'Click to change';

                renderChapters();
                chaptersCard.style.display = 'block';
                optionsCard.style.display  = 'block';

                convertBtn.disabled = false;
                convertBtn.textContent = `Convert to ${formatSelect.value.toUpperCase()}`;

            } catch (err) {
                showError(err.message);
                dropZone.classList.remove('has-file');
                dropZone.querySelector('.drop-zone-text').textContent = 'Drop your EPUB here or click to browse';
                dropZone.querySelector('.drop-zone-hint').textContent = 'EPUB files only';
            }
        }

        function renderChapters() {
            chapterList.innerHTML = '';
            chapters.forEach((ch, i) => {
                const isContent = !ch.is_front_matter && !ch.is_back_matter;
                const div = document.createElement('div');
                div.className = 'chapter-item';

                let badge = '';
                if (ch.is_front_matter) badge = '<span class="badge">front</span>';
                if (ch.is_back_matter)  badge = '<span class="badge">back</span>';

                div.innerHTML = `
                    <input type="checkbox" ${isContent ? 'checked' : ''} data-index="${i}">
                    <span class="title">${escapeHtml(ch.title)}${badge}</span>
                    <span class="meta">${formatWords(ch.words)} · ${formatChapterDuration(ch.words)}</span>
                `;

                div.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const cb = div.querySelector('input');
                        cb.checked = !cb.checked;
                        updateSelectionStats();
                    }
                });
                div.querySelector('input').addEventListener('change', updateSelectionStats);
                chapterList.appendChild(div);
            });
            updateSelectionStats();
            updateBitrateNote();
        }

        function updateSelectionStats() {
            const selected = getSelectedChapters();
            const words = selected.reduce((s, i) => s + chapters[i].words, 0);
            selectionStats.textContent = `${selected.length} of ${chapters.length} · ${words.toLocaleString()} words`;

            const durationEl   = document.getElementById('durationEstimate');
            const durationVal  = document.getElementById('durationEstimateValue');
            const durationNote = document.getElementById('durationEstimateNote');
            if (words > 0) {
                durationEl.style.display = 'flex';
                durationVal.textContent  = formatDuration(words);
                const mode = textProcessingSelect.value;
                durationNote.textContent = mode === 'speed' ? 'condensed to ~30%'
                                         : mode === 'summary' ? 'key points only (~10%)' : '';
            } else {
                durationEl.style.display = 'none';
            }
        }

        function selectAll()  { chapterList.querySelectorAll('input').forEach(c => c.checked = true);  updateSelectionStats(); }
        function selectNone() { chapterList.querySelectorAll('input').forEach(c => c.checked = false); updateSelectionStats(); }

        function getSelectedChapters() {
            return Array.from(chapterList.querySelectorAll('input:checked')).map(cb => parseInt(cb.dataset.index));
        }

        // ── Conversion ────────────────────────────────────────────

        convertBtn.addEventListener('click', startConversion);

        async function startConversion() {
            const selected = getSelectedChapters();
            if (selected.length === 0) { showError('Please select at least one chapter'); return; }

            // Request notification permission on first conversion (natural moment to ask)
            if (Notification.permission === 'default') Notification.requestPermission();

            const currentUploadId = uploadId;
            const currentTitle    = bookTitle.textContent || 'Untitled';

            convertBtn.disabled    = true;
            convertBtn.textContent = 'Starting…';
            clearError();

            const formData = new FormData();
            formData.append('upload_id',         currentUploadId);
            formData.append('selected_chapters',  JSON.stringify(selected));
            formData.append('voice',              voiceSelect.value);
            formData.append('output_format',      formatSelect.value);
            formData.append('per_chapter',        perChapter.checked);
            formData.append('announce_chapters',  announceChapters.checked);
            formData.append('text_processing',    textProcessingSelect.value);
            formData.append('speed',              (document.querySelector('input[name="speed"]:checked') || {value: '1.0'}).value);
            formData.append('bitrate',            bitrateSelect.value);

            try {
                const response = await fetch('/api/convert', { method: 'POST', body: formData });
                if (!response.ok) throw new Error('Conversion failed');

                const data  = await response.json();
                const jobId = data.job_id;
                const jobSettings = {
                    voice: voiceSelect.value,
                    output_format: formatSelect.value,
                    text_processing: textProcessingSelect.value,
                    speed: parseFloat((document.querySelector('input[name="speed"]:checked') || {value: '1.0'}).value),
                    bitrate: parseInt(bitrateSelect.value),
                };

                addJob(jobId, currentTitle, { settings: jobSettings });
                // Save to localStorage so reconnect can restore this job
                addHistoryEntry({ jobId, title: currentTitle, author: '', settings: jobSettings, files: [], completedAt: null });
                listenForProgress(jobId);
                resetForm();

            } catch (err) {
                showError(err.message);
                convertBtn.disabled    = false;
                convertBtn.textContent = `Convert to ${formatSelect.value.toUpperCase()}`;
            }
        }

        function resetForm() {
            uploadId  = null;
            chapters  = [];

            dropZone.classList.remove('has-file', 'dragover');
            dropZone.querySelector('.drop-zone-text').textContent = 'Drop your EPUB here or click to browse';
            dropZone.querySelector('.drop-zone-hint').textContent = 'EPUB files only';
            epubInput.value = '';

            bookInfo.className  = 'book-info';
            bookCover.src       = '';
            bookTitle.textContent = bookAuthor.textContent = bookStats.textContent = '';
            chaptersCard.style.display = optionsCard.style.display = 'none';

            convertBtn.disabled    = true;
            convertBtn.textContent = 'Select an EPUB to begin';
            clearError();
        }

        // ── Error helpers ─────────────────────────────────────────

        function showError(message) {
            errorText.textContent  = message;
            convertBtn.textContent = uploadId ? `Convert to ${formatSelect.value.toUpperCase()}` : 'Select an EPUB to begin';
            convertBtn.disabled    = !uploadId;
        }

        function clearError() { errorText.textContent = ''; }

        // ── Job History (localStorage + server) ───────────────────

        const HISTORY_KEY = 'inkvoice_history';
        const HISTORY_MAX = 20;

        function loadHistory() {
            try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; }
            catch { return []; }
        }

        function saveHistory(entries) {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(entries));
        }

        function addHistoryEntry(entry) {
            const entries = loadHistory();
            const filtered = entries.filter(e => e.jobId !== entry.jobId);
            filtered.unshift(entry);
            saveHistory(filtered.slice(0, HISTORY_MAX));
            renderHistory();
        }

        function clearHistory() {
            localStorage.removeItem(HISTORY_KEY);
            renderHistory();
        }

        function formatHistoryDate(isoOrEpoch) {
            try {
                const d = typeof isoOrEpoch === 'number'
                    ? new Date(isoOrEpoch * 1000)
                    : new Date(isoOrEpoch);
                return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' })
                    + ' at ' + d.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
            } catch { return String(isoOrEpoch); }
        }

        async function renderHistory() {
            // Merge localStorage + server jobs
            const local = loadHistory();
            let serverJobs = [];
            try {
                const res = await fetch('/api/jobs');
                if (res.ok) {
                    const d = await res.json();
                    serverJobs = d.jobs || [];
                }
            } catch (_) {}

            // Build merged list (server is source of truth, local adds metadata like title/author)
            const byId = new Map();
            local.forEach(e => byId.set(e.jobId, e));
            serverJobs.forEach(sj => {
                const existing = byId.get(sj.job_id) || {};
                byId.set(sj.job_id, {
                    jobId: sj.job_id,
                    title: sj.title || existing.title || 'Untitled',
                    author: sj.author || existing.author || '',
                    files: sj.files && sj.files.length > 0 ? sj.files : (existing.files || []),
                    completedAt: sj.completed_at || existing.completedAt,
                    settings: sj.settings || existing.settings || {},
                    summary: sj.summary || existing.summary || null,
                });
            });

            const entries = Array.from(byId.values())
                .filter(e => e.files && e.files.length > 0)
                .sort((a, b) => {
                    const ta = typeof a.completedAt === 'number' ? a.completedAt : new Date(a.completedAt || 0).getTime() / 1000;
                    const tb = typeof b.completedAt === 'number' ? b.completedAt : new Date(b.completedAt || 0).getTime() / 1000;
                    return tb - ta;
                });

            // Save merged back to localStorage
            saveHistory(entries.map(e => ({
                ...e, completedAt: e.completedAt || new Date().toISOString()
            })));

            const section = document.getElementById('historySection');
            const list    = document.getElementById('historyList');

            if (entries.length === 0) { section.style.display = 'none'; list.innerHTML = ''; return; }

            section.style.display = 'block';
            list.innerHTML = '';

            for (const entry of entries) {
                const div = document.createElement('div');
                div.className = 'history-entry';

                const authorPart = entry.author ? `${escapeHtml(entry.author)} · ` : '';
                const datePart   = formatHistoryDate(entry.completedAt);
                const chipsHtml  = renderSettingsChips(entry.settings || {});
                const summaryText = (() => {
                    if (!entry.summary) return '';
                    const s = entry.summary;
                    const parts = [];
                    if (s.chapter_count) parts.push(`${s.chapter_count} chapter${s.chapter_count !== 1 ? 's' : ''}`);
                    if (s.conversion_time_seconds) parts.push(formatConversionTime(s.conversion_time_seconds));
                    return parts.join(' · ');
                })();

                div.innerHTML = `
                    <div class="history-entry-header">
                        <div class="history-entry-title">${escapeHtml(entry.title)}</div>
                        <div class="history-entry-meta">${authorPart}${datePart}</div>
                    </div>
                    ${chipsHtml ? `<div class="job-settings-row" style="margin-bottom:6px">${chipsHtml}</div>` : ''}
                    ${summaryText ? `<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:4px">${escapeHtml(summaryText)}</div>` : ''}
                    <div class="history-entry-files" data-jobid="${entry.jobId}"></div>
                `;

                list.appendChild(div);

                const filesContainer = div.querySelector('.history-entry-files');
                for (const filename of (entry.files || [])) {
                    const url  = `/api/download/${entry.jobId}/${encodeURIComponent(filename)}`;
                    const span = document.createElement('span');
                    span.innerHTML = renderFilePill(filename, url, null);
                    filesContainer.appendChild(span);
                    checkFileAvailable(url).then(ok => { span.innerHTML = renderFilePill(filename, url, ok); });
                }
            }
        }

        function renderFilePill(filename, url, available) {
            const dlIcon = '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
            if (available !== false) {
                return `<a class="history-file-link" href="${url}" download>${dlIcon} ${escapeHtml(filename)}</a>`;
            }
            return `<span class="history-file-expired"><span class="filename">${escapeHtml(filename)}</span><span class="expired-badge">Expired</span></span>`;
        }

        async function checkFileAvailable(url) {
            try { return (await fetch(url, { method: 'HEAD' })).ok; }
            catch { return false; }
        }

        document.getElementById('historyClearBtn').addEventListener('click', () => {
            if (confirm('Clear all conversion history?')) clearHistory();
        });

        // ── Reconnect in-progress jobs on page load ───────────────
        async function reconnectInProgressJobs() {
            try {
                const res = await fetch('/api/jobs');
                if (!res.ok) return;
                const d = await res.json();
                for (const sj of (d.jobs || [])) {
                    if (sj.status !== 'processing') continue;
                    if (jobQueue.has(sj.job_id)) continue; // Already tracked
                    const title = sj.title || sj.job_id.slice(0, 8);
                    addJob(sj.job_id, title, {
                        author: sj.author || '',
                        settings: sj.settings || {},
                        status: 'processing',
                        progress: sj.progress || 0,
                    });
                    listenForProgress(sj.job_id);
                }
            } catch (_) {}
        }

        reconnectInProgressJobs();
        renderHistory();

        // ── Library tab ───────────────────────────────────────────

        let libraryData = [];  // Full library from server

        function switchTab(tab) {
            const convertPanel = document.getElementById('convertPanel');
            const libraryPanel = document.getElementById('libraryPanel');
            const tabConvert   = document.getElementById('tabConvert');
            const tabLibrary   = document.getElementById('tabLibrary');

            if (tab === 'convert') {
                convertPanel.classList.remove('panel-hidden');
                convertPanel.classList.add('panel-visible');
                libraryPanel.classList.remove('panel-visible');
                libraryPanel.classList.add('panel-hidden');
                tabConvert.classList.add('active');
                tabLibrary.classList.remove('active');
            } else {
                libraryPanel.classList.remove('panel-hidden');
                libraryPanel.classList.add('panel-visible');
                convertPanel.classList.remove('panel-visible');
                convertPanel.classList.add('panel-hidden');
                tabLibrary.classList.add('active');
                tabConvert.classList.remove('active');
                loadLibrary();
            }
        }

        function formatAudioDuration(seconds) {
            if (!seconds) return '';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            if (h > 0) return `${h}h ${m}m`;
            return `${m}m`;
        }

        function formatBytes(bytes) {
            if (bytes == null) return '';
            if (bytes >= 1024 * 1024 * 1024) return `${(bytes / (1024 * 1024 * 1024)).toFixed(1)} GB`;
            if (bytes >= 1024 * 1024)        return `${(bytes / (1024 * 1024)).toFixed(0)} MB`;
            if (bytes >= 1024)               return `${(bytes / 1024).toFixed(0)} KB`;
            return `${bytes} B`;
        }

        function formatRelativeDate(epoch) {
            if (!epoch) return '';
            const now  = Date.now() / 1000;
            const diff = now - epoch;
            if (diff < 60)          return 'just now';
            if (diff < 3600)        return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400)       return `${Math.floor(diff / 3600)}h ago`;
            if (diff < 86400 * 7)   return `${Math.floor(diff / 86400)}d ago`;
            const d = new Date(epoch * 1000);
            return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function inferFormat(files) {
            if (!files || !files.length) return '';
            const name = files[0].toLowerCase();
            if (name.endsWith('.m4b')) return 'M4B';
            if (name.endsWith('.mp3')) return 'MP3';
            return '';
        }

        async function loadLibrary() {
            const grid = document.getElementById('libraryGrid');
            grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted);font-size:0.88rem;">Loading…</div>`;
            try {
                const res = await fetch('/api/library');
                if (!res.ok) throw new Error('Failed to load library');
                const data = await res.json();
                libraryData = data.library || [];
                renderLibraryGrid(libraryData);
            } catch (e) {
                grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--error);font-size:0.88rem;">Failed to load library: ${escapeHtml(e.message)}</div>`;
            }
        }

        function filterLibrary() {
            const q = (document.getElementById('librarySearch').value || '').toLowerCase();
            if (!q) { renderLibraryGrid(libraryData); return; }
            const filtered = libraryData.filter(item =>
                (item.title || '').toLowerCase().includes(q) ||
                (item.author || '').toLowerCase().includes(q)
            );
            renderLibraryGrid(filtered);
        }

        function renderLibraryGrid(items) {
            const grid = document.getElementById('libraryGrid');
            grid.innerHTML = '';

            if (!items || items.length === 0) {
                grid.innerHTML = `
                    <div class="library-empty" style="grid-column:1/-1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                        </svg>
                        <strong>No audiobooks yet</strong>
                        <p>Convert an EPUB to get started.</p>
                    </div>`;
                return;
            }

            items.forEach((item, idx) => {
                const card = buildLibCard(item, idx);
                grid.appendChild(card);
            });
        }

        function buildLibCard(item, idx) {
            const card = document.createElement('div');
            card.className = 'lib-card';
            card.dataset.jobId = item.job_id;
            card.style.animationDelay = `${idx * 0.04}s`;

            // Cover image or placeholder
            let coverHtml;
            if (item.has_cover && item.cover_url) {
                coverHtml = `<img class="lib-card-cover" src="${escapeHtml(item.cover_url)}" alt="" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                    <div class="lib-card-cover-placeholder" style="display:none;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                        </svg>
                    </div>`;
            } else {
                coverHtml = `<div class="lib-card-cover-placeholder">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </svg>
                </div>`;
            }

            const fmt      = inferFormat(item.files);
            const size     = formatBytes(item.total_size_bytes);
            const date     = formatRelativeDate(item.completed_at);
            const title    = escapeHtml(item.title || 'Untitled');
            const author   = escapeHtml(item.author || '');
            const duration = formatAudioDuration(item.duration_seconds);

            card.innerHTML = `
                ${coverHtml}
                <div class="lib-card-body">
                    <div class="lib-card-title" title="${title}">${title}</div>
                    ${author ? `<div class="lib-card-author">${author}</div>` : ''}
                    ${duration ? `<div class="lib-card-duration">${duration}</div>` : ''}
                    <div class="lib-card-meta">
                        ${fmt ? `<span class="lib-format-badge">${fmt}</span>` : ''}
                        ${size ? `<span class="lib-card-size">${size}</span>` : ''}
                    </div>
                    <div class="lib-card-date">${date}</div>
                </div>
                <div class="lib-card-actions" id="lib-actions-${escapeHtml(item.job_id)}">
                </div>`;

            const actionsEl = card.querySelector(`#lib-actions-${item.job_id}`);

            // Download buttons (one per file)
            item.files.forEach(filename => {
                const url = `/api/download/${encodeURIComponent(item.job_id)}/${encodeURIComponent(filename)}`;
                const a = document.createElement('a');
                a.className = 'lib-download-btn';
                a.href = url;
                a.download = filename;
                a.title = filename;
                a.textContent = item.files.length === 1 ? 'Download' : filename;
                actionsEl.appendChild(a);
            });

            // Delete button with inline confirm
            const deleteRow = document.createElement('div');
            deleteRow.innerHTML = `
                <button class="lib-delete-btn" id="lib-del-${item.job_id}">Delete</button>
                <div class="lib-delete-confirm" id="lib-confirm-${item.job_id}">
                    <span>Delete permanently?</span>
                    <button class="lib-confirm-yes">Yes</button>
                    <button class="lib-confirm-no">No</button>
                </div>`;
            actionsEl.appendChild(deleteRow);

            // Wire delete flow
            const delBtn     = deleteRow.querySelector('.lib-delete-btn');
            const confirmEl  = deleteRow.querySelector('.lib-delete-confirm');
            const yesBtn     = deleteRow.querySelector('.lib-confirm-yes');
            const noBtn      = deleteRow.querySelector('.lib-confirm-no');

            delBtn.addEventListener('click', () => {
                delBtn.style.display = 'none';
                confirmEl.classList.add('visible');
            });
            noBtn.addEventListener('click', () => {
                confirmEl.classList.remove('visible');
                delBtn.style.display = '';
            });
            yesBtn.addEventListener('click', async () => {
                yesBtn.disabled = true;
                yesBtn.textContent = '…';
                try {
                    const res = await fetch(`/api/library/${encodeURIComponent(item.job_id)}`, { method: 'DELETE' });
                    if (!res.ok) throw new Error('Delete failed');
                    // Animate card out then remove
                    card.classList.add('removing');
                    card.addEventListener('animationend', () => {
                        card.remove();
                        // Update in-memory list
                        libraryData = libraryData.filter(x => x.job_id !== item.job_id);
                        // Show empty state if needed
                        const grid = document.getElementById('libraryGrid');
                        if (grid && !grid.querySelector('.lib-card')) {
                            renderLibraryGrid([]);
                        }
                    }, { once: true });
                } catch (e) {
                    yesBtn.disabled = false;
                    yesBtn.textContent = 'Yes';
                    confirmEl.classList.remove('visible');
                    delBtn.style.display = '';
                    alert('Failed to delete: ' + e.message);
                }
            });

            return card;
        }
    </script>
</body>
</html>
